<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maps Guesser - Leaderboard & Name System</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #map {
            height: 300px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            cursor: crosshair;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .dev-badge {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }
        
        .leaderboard-gold { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
        .leaderboard-silver { background-color: #f3f4f6; border-left: 4px solid #9ca3af; }
        .leaderboard-bronze { background-color: #fef7ed; border-left: 4px solid #f97316; }
        
        .name-change-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .cooldown-timer {
            font-size: 0.7rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Overlay -->
    <div id="globalLoading" class="loading-overlay">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <div class="text-xl mb-2">Memuat Game Maps Guesser</div>
            <div class="text-sm text-gray-300">Menyiapkan sistem...</div>
        </div>
    </div>

    <div id="app" class="min-h-screen flex flex-col hidden">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-3 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">üéØ Maps Guesser</h1>
                <div class="flex items-center space-x-2">
                    <span id="playerDisplay">Player</span>
                    <span id="devBadge" class="dev-badge hidden">Dev</span>
                    <div class="bg-green-500 px-2 py-1 rounded text-xs">‚úÖ Online</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 container mx-auto p-3">
            <!-- Lobby Screen -->
            <div id="lobbyScreen" class="bg-white rounded-lg shadow-sm p-4">
                <h2 class="text-lg font-bold mb-4 text-center">Lobby Game</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Player & Settings -->
                    <div class="space-y-3">
                        <!-- Name Settings -->
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pengaturan Nama</label>
                            <div class="flex space-x-2 mb-2">
                                <input type="text" id="playerName" placeholder="Nama Anda" 
                                       class="flex-1 border border-gray-300 rounded-md p-2 text-sm" 
                                       maxlength="15">
                                <button id="saveNameBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 rounded text-sm transition">
                                    üíæ Simpan
                                </button>
                            </div>
                            <div id="nameCooldown" class="text-xs text-gray-500 hidden"></div>
                        </div>
                        
                        <!-- Friend System -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tambah Teman</label>
                            <div class="flex space-x-2 mb-1">
                                <input type="text" id="friendName" placeholder="Nama teman" 
                                       class="flex-1 border border-gray-300 rounded-md p-2 text-sm"
                                       maxlength="15">
                                <button id="addFriendBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 rounded text-sm transition">
                                    ‚ûï
                                </button>
                            </div>
                            <div id="friendsList" class="space-y-1 max-h-20 overflow-y-auto">
                                <!-- Daftar teman -->
                            </div>
                        </div>
                        
                        <!-- Lobby System -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kode Lobby</label>
                            <div class="flex space-x-2 mb-1">
                                <input type="text" id="lobbyCode" placeholder="Kode Lobby" 
                                       class="flex-1 border border-gray-300 rounded-md p-2 text-sm"
                                       value="ABC123" maxlength="6">
                                <button id="generateCodeBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 rounded text-sm transition">
                                    üîÑ
                                </button>
                            </div>
                            <button id="joinLobbyBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded text-sm transition">
                                üéÆ Buat/Gabung Lobby
                            </button>
                        </div>
                    </div>
                    
                    <!-- Game Settings & Leaderboard -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Ronde</label>
                            <select id="roundsSelect" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                                <option value="3">3 Ronde</option>
                                <option value="5" selected>5 Ronde</option>
                                <option value="7">7 Ronde</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                            <select id="regionSelect" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                                <option value="jogja">üèØ Yogyakarta</option>
                                <option value="bali">üå¥ Bali</option>
                                <option value="jakarta">üèôÔ∏è Jakarta</option>
                            </select>
                        </div>
                        
                        <!-- Mini Leaderboard -->
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <h3 class="font-bold text-sm mb-2">üèÜ Leaderboard Global</h3>
                            <div id="miniLeaderboard" class="space-y-1 text-xs">
                                <div class="flex justify-between">
                                    <span>1. Wira <span class="dev-badge">Dev</span></span>
                                    <span class="font-bold">15.200</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>2. Andi</span>
                                    <span>12.500</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>3. Sari</span>
                                    <span>10.800</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Players in Lobby -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-md font-bold">Pemain di Lobby (<span id="playerCount">1</span>/6)</h3>
                        <div class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                            üí§ Menunggu
                        </div>
                    </div>
                    <div id="playersList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                        <!-- Players akan muncul di sini -->
                    </div>
                </div>
                
                <!-- Lobby Controls -->
                <div class="mt-4 flex space-x-2">
                    <button id="startGameBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded text-sm transition">
                        üöÄ Mulai Game
                    </button>
                    <button id="viewLeaderboardBtn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded text-sm transition">
                        üìä Leaderboard
                    </button>
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div id="leaderboardScreen" class="bg-white rounded-lg shadow-sm p-4 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">üèÜ Leaderboard Global</h2>
                    <button id="backToLobbyBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition">
                        ‚Üê Kembali
                    </button>
                </div>
                
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="leaderboard-gold p-3 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="font-bold text-lg mr-2">ü•á</span>
                                <span class="font-bold">Wira <span class="dev-badge">Dev</span></span>
                            </div>
                            <span class="font-bold text-lg">15.200</span>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">Terakhir main: 2 jam lalu</div>
                    </div>
                    
                    <div class="leaderboard-silver p-3 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="font-bold text-lg mr-2">ü•à</span>
                                <span>Andi</span>
                            </div>
                            <span class="font-bold">12.500</span>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">Terakhir main: 1 hari lalu</div>
                    </div>
                    
                    <div class="leaderboard-bronze p-3 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="font-bold text-lg mr-2">ü•â</span>
                                <span>Sari</span>
                            </div>
                            <span class="font-bold">10.800</span>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">Terakhir main: 3 jam lalu</div>
                    </div>
                    
                    <!-- More leaderboard entries -->
                    <div id="fullLeaderboard" class="space-y-2">
                        <!-- Leaderboard entries akan diload di sini -->
                    </div>
                </div>
                
                <!-- Player Stats -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                    <h3 class="font-bold text-sm mb-2">üìà Statistik Anda</h3>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>Peringkat: <span id="playerRank" class="font-bold">-</span></div>
                        <div>Skor Tertinggi: <span id="playerHighScore" class="font-bold">-</span></div>
                        <div>Total Game: <span id="totalGames" class="font-bold">-</span></div>
                        <div>Rata-rata Skor: <span id="averageScore" class="font-bold">-</span></div>
                    </div>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="hidden">
                <!-- Game content... -->
                <div class="text-center p-8 bg-white rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Game Screen</h2>
                    <p>Game akan dimulai...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =============================================
        // MAPS GUESSER - Leaderboard & Name System
        // =============================================

        // Game State
        let gameState = {
            playerId: null,
            playerName: '',
            isDev: false,
            nameChangeCooldown: null,
            friends: [],
            score: 0,
            leaderboard: []
        };

        // DOM Elements
        const globalLoading = document.getElementById('globalLoading');
        const app = document.getElementById('app');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const leaderboardScreen = document.getElementById('leaderboardScreen');
        const gameScreen = document.getElementById('gameScreen');
        const playerNameInput = document.getElementById('playerName');
        const saveNameBtn = document.getElementById('saveNameBtn');
        const nameCooldown = document.getElementById('nameCooldown');
        const playerDisplay = document.getElementById('playerDisplay');
        const devBadge = document.getElementById('devBadge');
        const viewLeaderboardBtn = document.getElementById('viewLeaderboardBtn');
        const backToLobbyBtn = document.getElementById('backToLobbyBtn');
        const fullLeaderboard = document.getElementById('fullLeaderboard');

        // Initialize Application
        function init() {
            console.log('Initializing game...');
            
            try {
                // Setup player ID
                gameState.playerId = 'player_' + Date.now();
                
                // Load saved data
                loadPlayerData();
                loadLeaderboard();
                
                // Setup event listeners
                setupEventListeners();
                
                // Show app
                setTimeout(() => {
                    globalLoading.classList.add('hidden');
                    app.classList.remove('hidden');
                    updateUI();
                }, 1000);
                
            } catch (error) {
                console.error('Init error:', error);
                alert('Error memuat game: ' + error.message);
            }
        }

        // Load Player Data from localStorage
        function loadPlayerData() {
            const savedData = localStorage.getItem('mapsGuesserPlayer');
            
            if (savedData) {
                const data = JSON.parse(savedData);
                gameState.playerName = data.name || '';
                gameState.isDev = data.isDev || false;
                gameState.nameChangeCooldown = data.nameChangeCooldown || null;
                gameState.friends = data.friends || [];
                gameState.score = data.score || 0;
            } else {
                // Default values
                gameState.playerName = 'Player' + Math.floor(Math.random() * 1000);
                gameState.isDev = false;
                gameState.nameChangeCooldown = null;
                gameState.friends = [];
                gameState.score = 0;
                savePlayerData();
            }
            
            // Check if player name is "Wira" for dev badge
            if (gameState.playerName.toLowerCase() === 'wira') {
                gameState.isDev = true;
                savePlayerData();
            }
            
            updateNameCooldown();
        }

        // Save Player Data to localStorage
        function savePlayerData() {
            const data = {
                name: gameState.playerName,
                isDev: gameState.isDev,
                nameChangeCooldown: gameState.nameChangeCooldown,
                friends: gameState.friends,
                score: gameState.score,
                lastPlayed: new Date().toISOString()
            };
            localStorage.setItem('mapsGuesserPlayer', JSON.stringify(data));
        }

        // Load Leaderboard from localStorage
        function loadLeaderboard() {
            const savedLeaderboard = localStorage.getItem('mapsGuesserLeaderboard');
            
            if (savedLeaderboard) {
                gameState.leaderboard = JSON.parse(savedLeaderboard);
            } else {
                // Default leaderboard with dev
                gameState.leaderboard = [
                    { name: 'Wira', score: 15200, isDev: true, lastPlayed: new Date().toISOString() },
                    { name: 'Andi', score: 12500, isDev: false, lastPlayed: new Date(Date.now() - 86400000).toISOString() },
                    { name: 'Sari', score: 10800, isDev: false, lastPlayed: new Date(Date.now() - 10800000).toISOString() },
                    { name: 'Budi', score: 9800, isDev: false, lastPlayed: new Date(Date.now() - 172800000).toISOString() },
                    { name: 'Dewi', score: 8700, isDev: false, lastPlayed: new Date(Date.now() - 259200000).toISOString() }
                ];
                saveLeaderboard();
            }
            
            updateLeaderboardDisplay();
        }

        // Save Leaderboard to localStorage
        function saveLeaderboard() {
            localStorage.setItem('mapsGuesserLeaderboard', JSON.stringify(gameState.leaderboard));
        }

        // Add Score to Leaderboard
        function addScoreToLeaderboard(name, score, isDev = false) {
            const existingEntry = gameState.leaderboard.find(entry => entry.name === name);
            
            if (existingEntry) {
                if (score > existingEntry.score) {
                    existingEntry.score = score;
                    existingEntry.lastPlayed = new Date().toISOString();
                }
            } else {
                gameState.leaderboard.push({
                    name: name,
                    score: score,
                    isDev: isDev,
                    lastPlayed: new Date().toISOString()
                });
            }
            
            // Sort leaderboard by score descending
            gameState.leaderboard.sort((a, b) => b.score - a.score);
            
            // Keep only top 100 entries
            if (gameState.leaderboard.length > 100) {
                gameState.leaderboard = gameState.leaderboard.slice(0, 100);
            }
            
            saveLeaderboard();
            updateLeaderboardDisplay();
        }

        // Update Leaderboard Display
        function updateLeaderboardDisplay() {
            // Update mini leaderboard
            const miniLeaderboard = document.getElementById('miniLeaderboard');
            miniLeaderboard.innerHTML = '';
            
            gameState.leaderboard.slice(0, 3).forEach((player, index) => {
                const entry = document.createElement('div');
                entry.className = 'flex justify-between';
                entry.innerHTML = `
                    <span>${index + 1}. ${player.name} ${player.isDev ? '<span class="dev-badge">Dev</span>' : ''}</span>
                    <span class="${index === 0 ? 'font-bold' : ''}">${player.score.toLocaleString()}</span>
                `;
                miniLeaderboard.appendChild(entry);
            });
            
            // Update full leaderboard
            fullLeaderboard.innerHTML = '';
            
            gameState.leaderboard.forEach((player, index) => {
                const entry = document.createElement('div');
                let bgClass = 'bg-white';
                if (index === 0) bgClass = 'leaderboard-gold';
                else if (index === 1) bgClass = 'leaderboard-silver';
                else if (index === 2) bgClass = 'leaderboard-bronze';
                
                entry.className = `${bgClass} p-3 rounded-lg`;
                entry.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="font-bold mr-2">${index + 1}.</span>
                            <span class="${index < 3 ? 'font-bold' : ''}">${player.name} ${player.isDev ? '<span class="dev-badge">Dev</span>' : ''}</span>
                        </div>
                        <span class="${index < 3 ? 'font-bold text-lg' : 'font-bold'}">${player.score.toLocaleString()}</span>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                        Terakhir main: ${formatLastPlayed(player.lastPlayed)}
                    </div>
                `;
                fullLeaderboard.appendChild(entry);
            });
            
            // Update player stats
            updatePlayerStats();
        }

        // Update Player Stats
        function updatePlayerStats() {
            const playerRank = gameState.leaderboard.findIndex(entry => entry.name === gameState.playerName) + 1;
            const playerEntry = gameState.leaderboard.find(entry => entry.name === gameState.playerName);
            
            document.getElementById('playerRank').textContent = playerRank > 0 ? playerRank : '-';
            document.getElementById('playerHighScore').textContent = playerEntry ? playerEntry.score.toLocaleString() : '0';
            // Simulate stats
            document.getElementById('totalGames').textContent = playerEntry ? Math.floor(playerEntry.score / 1000) : '0';
            document.getElementById('averageScore').textContent = playerEntry ? Math.floor(playerEntry.score / (playerEntry.score / 1000)) : '0';
        }

        // Format Last Played Time
        function formatLastPlayed(isoString) {
            const now = new Date();
            const lastPlayed = new Date(isoString);
            const diffMs = now - lastPlayed;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return `${diffMins} menit lalu`;
            } else if (diffHours < 24) {
                return `${diffHours} jam lalu`;
            } else {
                return `${diffDays} hari lalu`;
            }
        }

        // Name Change Cooldown System
        function updateNameCooldown() {
            const now = new Date();
            
            if (gameState.nameChangeCooldown) {
                const cooldownEnd = new Date(gameState.nameChangeCooldown);
                const timeLeft = cooldownEnd - now;
                
                if (timeLeft > 0) {
                    // Still in cooldown
                    const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                    nameCooldown.textContent = `Bisa ganti nama dalam ${daysLeft} hari`;
                    nameCooldown.classList.remove('hidden');
                    saveNameBtn.classList.add('name-change-disabled');
                    saveNameBtn.disabled = true;
                } else {
                    // Cooldown finished
                    gameState.nameChangeCooldown = null;
                    savePlayerData();
                    nameCooldown.classList.add('hidden');
                    saveNameBtn.classList.remove('name-change-disabled');
                    saveNameBtn.disabled = false;
                }
            } else {
                // No cooldown
                nameCooldown.classList.add('hidden');
                saveNameBtn.classList.remove('name-change-disabled');
                saveNameBtn.disabled = false;
            }
        }

        // Change Player Name
        function changePlayerName() {
            const newName = playerNameInput.value.trim();
            
            if (!newName) {
                alert('Masukkan nama yang valid!');
                return;
            }
            
            if (newName === gameState.playerName) {
                alert('Nama sama dengan sebelumnya!');
                return;
            }
            
            // Check cooldown
            if (gameState.nameChangeCooldown) {
                const cooldownEnd = new Date(gameState.nameChangeCooldown);
                if (cooldownEnd > new Date()) {
                    alert('Anda harus menunggu 10 hari untuk mengganti nama lagi!');
                    return;
                }
            }
            
            // Set new name and cooldown
            const oldName = gameState.playerName;
            gameState.playerName = newName;
            
            // Set cooldown for 10 days
            const cooldownEnd = new Date();
            cooldownEnd.setDate(cooldownEnd.getDate() + 10);
            gameState.nameChangeCooldown = cooldownEnd.toISOString();
            
            // Check for dev badge
            gameState.isDev = newName.toLowerCase() === 'wira';
            
            // Update leaderboard if player exists
            const leaderboardEntry = gameState.leaderboard.find(entry => entry.name === oldName);
            if (leaderboardEntry) {
                leaderboardEntry.name = newName;
                leaderboardEntry.isDev = gameState.isDev;
                saveLeaderboard();
            }
            
            savePlayerData();
            updateUI();
            updateNameCooldown();
            
            alert(`Nama berhasil diubah menjadi: ${newName}${gameState.isDev ? ' (Developer)' : ''}`);
        }

        // Update UI
        function updateUI() {
            playerNameInput.value = gameState.playerName;
            playerDisplay.textContent = gameState.playerName;
            
            if (gameState.isDev) {
                devBadge.classList.remove('hidden');
            } else {
                devBadge.classList.add('hidden');
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Name system
            saveNameBtn.addEventListener('click', changePlayerName);
            playerNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') changePlayerName();
            });
            
            // Leaderboard navigation
            viewLeaderboardBtn.addEventListener('click', function() {
                lobbyScreen.classList.add('hidden');
                leaderboardScreen.classList.remove('hidden');
            });
            
            backToLobbyBtn.addEventListener('click', function() {
                leaderboardScreen.classList.add('hidden');
                lobbyScreen.classList.remove('hidden');
            });
            
            // Simulate adding score (for testing)
            document.getElementById('joinLobbyBtn').addEventListener('click', function() {
                // Simulate game play and add score
                const newScore = gameState.score + Math.floor(Math.random() * 1000) + 500;
                gameState.score = newScore;
                addScoreToLeaderboard(gameState.playerName, newScore, gameState.isDev);
                savePlayerData();
                alert(`Skor baru: ${newScore}!`);
            });
        }

        // Start the application
        window.addEventListener('load', init);
    </script>
</body>
</html>
