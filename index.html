<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maps Guesser - Dynamic Timer & Wait System</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Animasi dan styles */
        @keyframes scorePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .score-pop {
            animation: scorePop 0.5s ease-in-out;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        /* Map container kecil persegi panjang */
        #map {
            height: 300px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            cursor: crosshair !important;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .guess-marker {
            background-color: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .answer-marker {
            background-color: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .pulse-marker {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .winner-glow {
            animation: winnerGlow 2s infinite;
        }
        
        @keyframes winnerGlow {
            0% { box-shadow: 0 0 20px gold; }
            50% { box-shadow: 0 0 40px gold; }
            100% { box-shadow: 0 0 20px gold; }
        }
        
        /* Loading styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Map controls kecil */
        .map-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 1000;
            background: white;
            padding: 5px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Timer styles */
        .timer-critical {
            background-color: #ef4444 !important;
            color: white !important;
            animation: pulse 0.5s infinite;
        }
        
        .timer-warning {
            background-color: #f59e0b !important;
            color: white !important;
        }
        
        /* Difficulty badges */
        .difficulty-easy { background-color: #10b981; color: white; }
        .difficulty-medium { background-color: #f59e0b; color: white; }
        .difficulty-hard { background-color: #ef4444; color: white; }
        
        /* Waiting animation */
        @keyframes waitingPulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .waiting-pulse {
            animation: waitingPulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Overlay -->
    <div id="globalLoading" class="loading-overlay">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <div class="text-xl">Memuat Game Maps Guesser</div>
            <div id="loadingDetail" class="text-sm mt-2 text-gray-300">Menyiapkan sistem</div>
        </div>
    </div>

    <div id="app" class="min-h-screen flex flex-col hidden">
        <!-- Header Compact -->
        <header class="bg-blue-600 text-white p-3 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">üéØ Maps Guesser</h1>
                <div id="connectionStatus" class="bg-green-500 px-2 py-1 rounded text-xs">
                    ‚úÖ Online
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 container mx-auto p-3">
            <!-- Lobby Screen -->
            <div id="lobbyScreen" class="bg-white rounded-lg shadow-sm p-4">
                <h2 class="text-lg font-bold mb-4 text-center">Lobby Game</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Player Info -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pemain</label>
                            <input type="text" id="playerName" placeholder="Nama Anda" 
                                   class="w-full border border-gray-300 rounded-md p-2 text-sm" 
                                   value="Pemain1" maxlength="15">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kode Lobby</label>
                            <div class="flex space-x-2 mb-1">
                                <input type="text" id="lobbyCode" placeholder="Kode Lobby" 
                                       class="flex-1 border border-gray-300 rounded-md p-2 text-sm"
                                       value="ABC123" maxlength="6">
                                <button id="generateCodeBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 rounded text-sm transition">
                                    üîÑ
                                </button>
                            </div>
                            <button id="joinLobbyBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded text-sm transition">
                                üéÆ Buat/Gabung Lobby
                            </button>
                        </div>
                    </div>
                    
                    <!-- Game Settings -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Ronde</label>
                            <select id="roundsSelect" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                                <option value="3">3 Ronde</option>
                                <option value="5" selected>5 Ronde</option>
                                <option value="7">7 Ronde</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                            <select id="regionSelect" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                                <option value="indonesia">üáÆüá© Indonesia</option>
                                <option value="jawa">üèùÔ∏è Jawa</option>
                                <option value="jogja">üèØ Yogyakarta</option>
                                <option value="bali">üå¥ Bali</option>
                                <option value="sumatra">üåã Sumatra</option>
                                <option value="mexico">üá≤üáΩ Mexico</option>
                                <option value="japan">üáØüáµ Japan</option>
                                <option value="europe">üá™üá∫ Europe</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Players in Lobby -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-md font-bold">Pemain di Lobby (<span id="playerCount">0</span>/5)</h3>
                        <div id="lobbyStatus" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                            üí§ Menunggu
                        </div>
                    </div>
                    <div id="playersList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                        <div class="p-2 bg-gray-100 rounded text-center text-gray-500 text-xs">
                            Belum ada pemain
                        </div>
                    </div>
                </div>
                
                <!-- Lobby Controls -->
                <div class="mt-4 flex space-x-2">
                    <button id="startGameBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded text-sm transition hidden">
                        üöÄ Mulai Game
                    </button>
                    <button id="leaveLobbyBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded text-sm transition hidden">
                        ‚ùå Keluar
                    </button>
                </div>

                <!-- Demo Players -->
                <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                    <h4 class="font-bold mb-2 text-sm">Demo Players:</h4>
                    <div class="flex space-x-1 flex-wrap gap-1">
                        <button id="addDemoPlayer1" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-2 rounded text-xs transition">
                            + Pemain 2
                        </button>
                        <button id="addDemoPlayer2" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-2 rounded text-xs transition">
                            + Pemain 3
                        </button>
                        <button id="addDemoPlayer3" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-2 rounded text-xs transition">
                            + Pemain 4
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="hidden">
                <div class="flex flex-col gap-3">
                    <!-- Map Container Compact -->
                    <div class="bg-white rounded-lg shadow-sm p-3">
                        <div class="flex justify-between items-center mb-2">
                            <div id="roundInfo" class="compact-info bg-blue-600 text-white rounded-lg px-3 py-1">
                                <strong>Ronde <span id="currentRoundDisplay">1</span>/<span id="totalRoundsDisplay">5</span></strong>
                            </div>
                            <div id="difficultyBadge" class="text-xs px-2 py-1 rounded-full font-medium">
                                <!-- Difficulty badge akan muncul di sini -->
                            </div>
                        </div>
                        
                        <!-- Location Clue -->
                        <div id="locationClue" class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h3 class="font-bold text-sm mb-1">üìç Petunjuk Lokasi</h3>
                            <div id="clueText" class="text-sm font-medium text-yellow-800">
                                Memuat petunjuk...
                            </div>
                        </div>
                        
                        <div class="relative">
                            <div id="mapLoading" class="loading-overlay hidden">
                                <div class="text-center">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <div class="text-sm">Memuat peta...</div>
                                </div>
                            </div>
                            
                            <!-- Map Controls -->
                            <div class="map-controls">
                                <div class="space-y-1">
                                    <button id="zoomInBtn" class="w-6 h-6 bg-white border border-gray-300 rounded flex items-center justify-center hover:bg-gray-100 text-xs">
                                        +
                                    </button>
                                    <button id="zoomOutBtn" class="w-6 h-6 bg-white border border-gray-300 rounded flex items-center justify-center hover:bg-gray-100 text-xs">
                                        -
                                    </button>
                                </div>
                            </div>

                            <div id="map"></div>
                            
                            <!-- Guess Instructions -->
                            <div id="guessInstructions" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-3 py-1 rounded text-xs">
                                üéØ Klik peta untuk menebak!
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Panel Compact -->
                    <div class="bg-white rounded-lg shadow-sm p-3">
                        <!-- Game Info -->
                        <div class="mb-3 p-2 bg-blue-50 rounded-lg">
                            <div class="flex justify-between items-center text-sm">
                                <span>Ronde: <span id="currentRound">1</span>/<span id="totalRounds">5</span></span>
                                <span>Lobby: <span id="currentLobbyCode">-</span></span>
                            </div>
                            <div class="mt-1">
                                <span id="roundTimer" class="bg-green-500 text-white px-2 py-1 rounded text-xs">‚è±Ô∏è <span id="timerValue">25</span>s</span>
                            </div>
                        </div>
                        
                        <!-- Waiting for Players -->
                        <div id="waitingForPlayers" class="mb-3 p-3 bg-purple-50 border border-purple-200 rounded-lg text-center hidden">
                            <div class="flex items-center justify-center space-x-2">
                                <div class="w-3 h-3 bg-purple-500 rounded-full waiting-pulse"></div>
                                <span class="text-sm font-medium text-purple-800">Menunggu pemain lain...</span>
                            </div>
                            <div id="waitingProgress" class="text-xs text-purple-600 mt-1">
                                <span id="playersFinished">0</span>/<span id="totalPlayers">0</span> pemain selesai
                            </div>
                        </div>
                        
                        <!-- Game Controls -->
                        <div id="gameControls" class="space-y-2 mb-3">
                            <button id="lockGuessBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded text-sm transition">
                                üîí Kunci Tebakan
                            </button>
                            <div class="flex space-x-2">
                                <button id="hintBtn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-2 px-3 rounded text-sm transition">
                                    üí° Petunjuk (<span id="hintCount">3</span>)
                                </button>
                                <button id="changeViewBtn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2 px-3 rounded text-sm transition">
                                    üîÑ Ganti Peta
                                </button>
                            </div>
                        </div>
                        
                        <!-- Round Result -->
                        <div id="roundResult" class="hidden p-2 bg-gray-100 rounded-lg mb-3">
                            <h3 class="font-bold mb-1 text-sm">üéØ Hasil Ronde</h3>
                            <p id="distanceResult" class="text-xs"></p>
                            <p id="roundScore" class="text-md font-bold"></p>
                        </div>

                        <!-- Players Status Compact -->
                        <div class="mb-3">
                            <h3 class="font-bold mb-1 text-sm">üë• Status Pemain</h3>
                            <div id="playersStatus" class="space-y-1 max-h-24 overflow-y-auto custom-scrollbar text-xs">
                                <!-- Players status will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Round Results Table -->
                <div id="roundResults" class="mt-3 bg-white rounded-lg shadow-sm p-3 hidden">
                    <h3 class="text-md font-bold mb-2">üìä Hasil Ronde <span id="resultsRoundNumber">1</span></h3>
                    <div id="resultsTable" class="overflow-x-auto text-xs mb-3">
                        <!-- Results table will be populated here -->
                    </div>
                    
                    <!-- Next Round Info -->
                    <div id="nextRoundInfo" class="p-2 bg-blue-50 rounded-lg text-center hidden">
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full waiting-pulse"></div>
                            <span class="text-xs text-blue-700">Menunggu pemain lain untuk ronde berikutnya...</span>
                        </div>
                    </div>
                    
                    <button id="nextRoundBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded text-sm transition hidden">
                        ‚û°Ô∏è Ronde Berikutnya
                    </button>
                </div>
            </div>

            <!-- Winner Screen -->
            <div id="winnerScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-xs w-full mx-4 text-center winner-glow">
                    <h2 class="text-xl font-bold mb-3 text-yellow-600">üéâ Pemenang! üéâ</h2>
                    <div id="winnerName" class="text-lg font-bold text-blue-600 mb-3"></div>
                    <div id="winnerScore" class="text-md mb-4">Skor: <span class="font-bold">5900</span></div>
                    <p class="text-gray-600 text-sm">Kembali ke lobby dalam <span id="countdown">10</span> detik...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =============================================
        // MAPS GUESSER - Dynamic Timer & Wait System
        // =============================================

        // Game state
        let gameState = {
            playerId: null,
            playerName: '',
            lobbyCode: '',
            isHost: false,
            currentRound: 0,
            totalRounds: 5,
            score: 0,
            roundScores: [],
            currentLocation: null,
            currentLocationName: '',
            currentDifficulty: 'medium',
            guessMarker: null,
            answerMarker: null,
            distanceLine: null,
            gameStarted: false,
            roundActive: false,
            hintsUsed: 0,
            maxHints: 3,
            startTime: null,
            map: null,
            selectedRegion: 'indonesia',
            roundTime: 0,
            roundTimer: null,
            players: {},
            currentRoundResults: [],
            currentGuess: null,
            mapInitialized: false,
            hasGuessed: false,
            timeLimit: 25,
            timeLeft: 25
        };

        // DAERAH SPESIFIK dengan difficulty level
        const specificLocations = {
            'indonesia': [
                { 
                    lat: -6.2088, lng: 106.8456, 
                    name: "Monas Jakarta",
                    clue: "Monumen nasional di pusat kota dengan api di puncaknya",
                    difficulty: "easy",
                    timeLimit: 19
                },
                { 
                    lat: -7.7971, lng: 110.3688, 
                    name: "Keraton Yogyakarta",
                    clue: "Istana kerajaan di kota pelajar dengan arsitektur Jawa",
                    difficulty: "easy", 
                    timeLimit: 19
                },
                { 
                    lat: -8.3405, lng: 115.0920, 
                    name: "Pantai Kuta Bali",
                    clue: "Pantai terkenal dengan ombak bagus untuk selancar di pulau dewata",
                    difficulty: "easy",
                    timeLimit: 19
                },
                { 
                    lat: -6.9175, lng: 107.6191, 
                    name: "Gedung Sate Bandung",
                    clue: "Gedung pemerintahan dengan ornamen tusuk sate di atapnya",
                    difficulty: "medium",
                    timeLimit: 22
                },
                { 
                    lat: -7.2504, lng: 112.7688, 
                    name: "Tugu Pahlawan Surabaya",
                    clue: "Monumen perjuangan setinggi 41.15 meter di kota pahlawan",
                    difficulty: "medium",
                    timeLimit: 22
                },
                { 
                    lat: -6.5950, lng: 106.7890, 
                    name: "Taman Safari Bogor",
                    clue: "Taman konservasi dengan safari malam di kawasan Puncak",
                    difficulty: "hard",
                    timeLimit: 25
                },
                { 
                    lat: -7.6079, lng: 110.2038, 
                    name: "Candi Borobudur",
                    clue: "Candi Buddha terbesar di dunia dengan stupa dan relief",
                    difficulty: "hard",
                    timeLimit: 25
                }
            ],
            'jogja': [
                { 
                    lat: -7.7971, lng: 110.3688, 
                    name: "Keraton Yogyakarta",
                    clue: "Istana Sultan Hamengkubuwono dengan pagar bata merah",
                    difficulty: "easy",
                    timeLimit: 19
                },
                { 
                    lat: -7.8032, lng: 110.3648, 
                    name: "Malioboro Street",
                    clue: "Jalan utama untuk belanja dengan hotel Phoenix di ujung",
                    difficulty: "easy",
                    timeLimit: 19
                },
                { 
                    lat: -7.7679, lng: 110.3783, 
                    name: "Sleman City Hall",
                    clue: "Kantor bupati di kawasan ring road utara dekat UGM",
                    difficulty: "medium",
                    timeLimit: 22
                },
                { 
                    lat: -7.7828, lng: 110.3909, 
                    name: "UGM Kampus",
                    clue: "Universitas negeri terbesar di Bulaksumur",
                    difficulty: "medium",
                    timeLimit: 22
                },
                { 
                    lat: -7.8075, lng: 110.3712, 
                    name: "Benteng Vredeburg",
                    clue: "Benteng Belanda dekat titik nol kilometer",
                    difficulty: "hard",
                    timeLimit: 25
                }
            ],
            'mexico': [
                { 
                    lat: 19.4326, lng: -99.1332, 
                    name: "Zocalo Mexico City",
                    clue: "Plaza utama dengan katedral dan istana nasional",
                    difficulty: "easy",
                    timeLimit: 19
                },
                { 
                    lat: 20.6597, lng: -103.3496, 
                    name: "Guadalajara Cathedral",
                    clue: "Katedral dengan menara kuning di kota mariachi",
                    difficulty: "medium",
                    timeLimit: 22
                },
                { 
                    lat: 21.1619, lng: -86.8515, 
                    name: "Cancun Beach",
                    clue: "Pantai berpasir putih dengan air turquoise di Riviera Maya",
                    difficulty: "easy",
                    timeLimit: 19
                },
                { 
                    lat: 19.0414, lng: -98.2063, 
                    name: "Pyramid of Cholula",
                    clue: "Piramida terbesar di dunia dengan gereja di puncaknya",
                    difficulty: "hard",
                    timeLimit: 25
                }
            ],
            'japan': [
                { 
                    lat: 35.6895, lng: 139.6917, 
                    name: "Shibuya Crossing Tokyo",
                    clue: "Persimpangan terkenal dengan layar elektronik raksasa",
                    difficulty: "easy",
                    timeLimit: 19
                },
                { 
                    lat: 34.6937, lng: 135.5023, 
                    name: "Osaka Castle",
                    clue: "Kastil bersejarah dengan warna hijau dan emas di tengah taman",
                    difficulty: "medium",
                    timeLimit: 22
                },
                { 
                    lat: 35.0116, lng: 135.7681, 
                    name: "Kinkaku-ji Kyoto",
                    clue: "Kuil emas yang memantul di danau dengan taman Jepang",
                    difficulty: "hard",
                    timeLimit: 25
                }
            ]
        };

        // DOM Elements
        const globalLoading = document.getElementById('globalLoading');
        const app = document.getElementById('app');
        const loadingDetail = document.getElementById('loadingDetail');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        const winnerScreen = document.getElementById('winnerScreen');
        const playerNameInput = document.getElementById('playerName');
        const lobbyCodeInput = document.getElementById('lobbyCode');
        const generateCodeBtn = document.getElementById('generateCodeBtn');
        const joinLobbyBtn = document.getElementById('joinLobbyBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const leaveLobbyBtn = document.getElementById('leaveLobbyBtn');
        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');
        const lobbyStatus = document.getElementById('lobbyStatus');
        const addDemoPlayer1 = document.getElementById('addDemoPlayer1');
        const addDemoPlayer2 = document.getElementById('addDemoPlayer2');
        const addDemoPlayer3 = document.getElementById('addDemoPlayer3');
        const mapLoading = document.getElementById('mapLoading');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const guessInstructions = document.getElementById('guessInstructions');
        const roundInfo = document.getElementById('roundInfo');
        const currentRoundDisplay = document.getElementById('currentRoundDisplay');
        const totalRoundsDisplay = document.getElementById('totalRoundsDisplay');
        const currentRoundElement = document.getElementById('currentRound');
        const totalRoundsElement = document.getElementById('totalRounds');
        const currentLobbyCode = document.getElementById('currentLobbyCode');
        const roundTimer = document.getElementById('roundTimer');
        const timerValue = document.getElementById('timerValue');
        const playersStatus = document.getElementById('playersStatus');
        const lockGuessBtn = document.getElementById('lockGuessBtn');
        const hintBtn = document.getElementById('hintBtn');
        const changeViewBtn = document.getElementById('changeViewBtn');
        const hintCountElement = document.getElementById('hintCount');
        const locationClue = document.getElementById('locationClue');
        const clueText = document.getElementById('clueText');
        const difficultyBadge = document.getElementById('difficultyBadge');
        const waitingForPlayers = document.getElementById('waitingForPlayers');
        const waitingProgress = document.getElementById('waitingProgress');
        const playersFinished = document.getElementById('playersFinished');
        const totalPlayers = document.getElementById('totalPlayers');
        const roundResultElement = document.getElementById('roundResult');
        const distanceResultElement = document.getElementById('distanceResult');
        const roundScoreElement = document.getElementById('roundScore');
        const roundResults = document.getElementById('roundResults');
        const resultsTable = document.getElementById('resultsTable');
        const resultsRoundNumber = document.getElementById('resultsRoundNumber');
        const nextRoundInfo = document.getElementById('nextRoundInfo');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const winnerName = document.getElementById('winnerName');
        const winnerScore = document.getElementById('winnerScore');
        const countdown = document.getElementById('countdown');

        // Initialize application
        async function init() {
            try {
                updateLoadingDetail("Menginisialisasi game...");
                await simulateLoad(1000);

                updateLoadingDetail("Membuat ID player...");
                gameState.playerId = generatePlayerId();
                await simulateLoad(500);

                updateLoadingDetail("Memuat pengaturan...");
                loadSavedSettings();
                await simulateLoad(500);

                updateLoadingDetail("Menyiapkan antarmuka...");
                setupEventListeners();
                await simulateLoad(500);

                // Sembunyikan loading dan tampilkan app
                globalLoading.style.opacity = '0';
                setTimeout(() => {
                    globalLoading.classList.add('hidden');
                    app.classList.remove('hidden');
                }, 500);

            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error inisialisasi: ' + error.message);
            }
        }

        // [Fungsi-fungsi utility dan lobby system sama seperti sebelumnya...]
        // Untuk menjaga panjang response, saya skip bagian yang sama

        // START ROUND dengan timer dynamic
        function startRound() {
            if (gameState.currentRound > gameState.totalRounds) {
                endGame();
                return;
            }

            gameState.roundActive = true;
            gameState.hasGuessed = false;
            gameState.hintsUsed = 0;
            gameState.startTime = Date.now();
            gameState.roundTime = 0;
            gameState.currentGuess = null;

            // Clear previous markers
            clearMapOverlays();

            // Hide previous results
            roundResultElement.classList.add('hidden');
            roundResults.classList.add('hidden');
            waitingForPlayers.classList.add('hidden');

            // Generate random location dengan difficulty
            generateRandomLocation();

            // Update UI
            updateGameUI();
            startRoundTimer();

            // Reset controls
            lockGuessBtn.classList.remove('bg-blue-500', 'bg-gray-400');
            lockGuessBtn.classList.add('bg-green-500');
            lockGuessBtn.textContent = 'üîí Kunci Tebakan';
            lockGuessBtn.disabled = false;
            hintBtn.disabled = false;
            hintBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            console.log(`Round ${gameState.currentRound} started - Difficulty: ${gameState.currentDifficulty}, Time: ${gameState.timeLimit}s`);
        }

        // Generate random location dengan difficulty
        function generateRandomLocation() {
            const region = gameState.selectedRegion;
            const locations = specificLocations[region] || specificLocations['indonesia'];
            
            if (locations && locations.length > 0) {
                // Pilih random location
                const randomLocation = locations[Math.floor(Math.random() * locations.length)];
                gameState.currentLocation = {
                    lat: randomLocation.lat,
                    lng: randomLocation.lng
                };
                gameState.currentLocationName = randomLocation.name;
                gameState.currentDifficulty = randomLocation.difficulty;
                gameState.timeLimit = randomLocation.timeLimit;
                gameState.timeLeft = randomLocation.timeLimit;

                // Update clue dan difficulty badge
                clueText.textContent = randomLocation.clue;
                updateDifficultyBadge(randomLocation.difficulty);
                
                console.log(`Selected location: ${randomLocation.name} (${randomLocation.difficulty})`);
            }

            // Set map view
            const bounds = regionBounds[region] || { center: [0, 0], zoom: 2 };
            gameState.map.setView(bounds.center, bounds.zoom);
        }

        // Update difficulty badge
        function updateDifficultyBadge(difficulty) {
            difficultyBadge.textContent = getDifficultyText(difficulty);
            difficultyBadge.className = `text-xs px-2 py-1 rounded-full font-medium difficulty-${difficulty}`;
        }

        // Get difficulty text
        function getDifficultyText(difficulty) {
            const texts = {
                'easy': 'üü¢ Mudah',
                'medium': 'üü° Sedang', 
                'hard': 'üî¥ Sulit'
            };
            return texts[difficulty] || difficulty;
        }

        // START ROUND TIMER dengan countdown
        function startRoundTimer() {
            if (gameState.roundTimer) {
                clearInterval(gameState.roundTimer);
            }

            gameState.timeLeft = gameState.timeLimit;
            updateTimerDisplay();

            gameState.roundTimer = setInterval(() => {
                gameState.timeLeft--;
                gameState.roundTime++;
                
                updateTimerDisplay();

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.roundTimer);
                    if (!gameState.hasGuessed) {
                        // Auto submit random guess jika waktu habis
                        autoSubmitGuess();
                    }
                }
            }, 1000);
        }

        // Update timer display dengan warna
        function updateTimerDisplay() {
            timerValue.textContent = gameState.timeLeft;
            
            // Update warna timer berdasarkan waktu tersisa
            roundTimer.classList.remove('timer-warning', 'timer-critical', 'bg-green-500', 'bg-yellow-500', 'bg-red-500');
            
            if (gameState.timeLeft <= 5) {
                roundTimer.classList.add('timer-critical');
            } else if (gameState.timeLeft <= 10) {
                roundTimer.classList.add('timer-warning');
            } else {
                roundTimer.classList.add('bg-green-500');
            }
        }

        // Auto submit guess ketika waktu habis
        function autoSubmitGuess() {
            if (gameState.hasGuessed || !gameState.roundActive) return;

            // Buat tebakan random di sekitar lokasi asli
            const randomOffset = () => (Math.random() - 0.5) * 0.5;
            const randomGuess = {
                lat: gameState.currentLocation.lat + randomOffset(),
                lng: gameState.currentLocation.lng + randomOffset()
            };

            gameState.currentGuess = randomGuess;
            gameState.hasGuessed = true;
            makeGuess(randomGuess);
            
            alert('Waktu habis! Tebakan otomatis dikirim.');
        }

        // MAKE GUESS dengan wait system
        function makeGuess(guessLocation) {
            if (!gameState.roundActive || gameState.hasGuessed) return;
            
            gameState.roundActive = false;
            gameState.hasGuessed = true;
            clearInterval(gameState.roundTimer);

            // Calculate distance and score dengan time bonus
            const distance = calculateDistance(
                gameState.currentLocation.lat, 
                gameState.currentLocation.lng,
                guessLocation.lat, 
                guessLocation.lng
            );
            
            const roundScore = calculateScore(distance, gameState.roundTime, gameState.timeLeft);
            gameState.score += roundScore;
            gameState.roundScores.push(roundScore);

            // Show results di map
            showRoundResult(guessLocation, distance, roundScore);
            
            // Update player status ke finished
            updatePlayerStatus('finished', roundScore, distance);

            console.log(`Guess made - Score: ${roundScore}, Distance: ${distance}m, Time Used: ${gameState.roundTime}s`);

            // Tampilkan waiting screen
            showWaitingForPlayers();
        }

        // Calculate score dengan time bonus dari sisa waktu
        function calculateScore(distance, timeUsed, timeLeft) {
            const baseScore = 5000;
            const maxDistance = 20000000;
            const distancePenalty = Math.min(distance / maxDistance, 1) * baseScore;
            
            // Time bonus dari sisa waktu (semakin banyak sisa waktu, semakin tinggi bonus)
            const timeBonus = (timeLeft / gameState.timeLimit) * 1000;
            
            // Difficulty multiplier
            const difficultyMultiplier = {
                'easy': 0.8,
                'medium': 1.0,
                'hard': 1.2
            };
            
            const multiplier = difficultyMultiplier[gameState.currentDifficulty] || 1.0;
            
            return Math.max(0, (baseScore - distancePenalty + timeBonus) * multiplier);
        }

        // Show waiting for players screen
        function showWaitingForPlayers() {
            waitingForPlayers.classList.remove('hidden');
            updateWaitingProgress();
            
            // Start polling untuk progress pemain lain
            const waitInterval = setInterval(() => {
                updateWaitingProgress();
                
                const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
                if (currentLobby) {
                    const finishedPlayers = Object.values(currentLobby.players).filter(p => p.status === 'finished').length;
                    const totalPlayers = Object.keys(currentLobby.players).length;
                    
                    // Jika semua pemain selesai, lanjut ke results
                    if (finishedPlayers >= totalPlayers) {
                        clearInterval(waitInterval);
                        showRoundResults();
                    }
                }
            }, 1000);
        }

        // Update waiting progress
        function updateWaitingProgress() {
            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (currentLobby) {
                const finishedPlayers = Object.values(currentLobby.players).filter(p => p.status === 'finished').length;
                const totalPlayersCount = Object.keys(currentLobby.players).length;
                
                playersFinished.textContent = finishedPlayers;
                totalPlayers.textContent = totalPlayersCount;
            }
        }

        // UPDATE PLAYER STATUS dengan distance
        function updatePlayerStatus(status, score = null, distance = null) {
            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (!currentLobby) return;

            currentLobby.players[gameState.playerId].status = status;
            if (score !== null) {
                currentLobby.players[gameState.playerId].score = gameState.score;
            }
            
            // Simpan round result
            if (!currentLobby.roundResults) {
                currentLobby.roundResults = {};
            }
            
            currentLobby.roundResults[gameState.playerId] = {
                name: gameState.playerName,
                score: Math.round(score),
                distance: Math.round(distance),
                time: gameState.roundTime,
                timeLeft: gameState.timeLeft
            };

            saveLobbyToStorage(gameState.lobbyCode, currentLobby);
        }

        // SHOW ROUND RESULTS dengan data semua pemain
        function showRoundResults() {
            waitingForPlayers.classList.add('hidden');
            
            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (!currentLobby || !currentLobby.roundResults) return;

            resultsRoundNumber.textContent = gameState.currentRound;
            
            // Build results table
            let html = `
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-1 text-left text-xs">Pemain</th>
                            <th class="p-1 text-right text-xs">Skor</th>
                            <th class="p-1 text-right text-xs">Jarak</th>
                            <th class="p-1 text-right text-xs">Waktu</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const resultsArray = Object.values(currentLobby.roundResults)
                .sort((a, b) => b.score - a.score);
            
            resultsArray.forEach((result, index) => {
                const distanceText = result.distance >= 1000 
                    ? `${(result.distance / 1000).toFixed(1)}km` 
                    : `${result.distance}m`;
                    
                const isCurrentPlayer = result.name === gameState.playerName;
                
                html += `
                    <tr class="${isCurrentPlayer ? 'bg-blue-50' : ''} ${index === 0 ? 'font-bold' : ''}">
                        <td class="p-1 text-xs">${result.name} ${isCurrentPlayer ? '(Anda)' : ''}</td>
                        <td class="p-1 text-right text-xs">${Math.round(result.score)}</td>
                        <td class="p-1 text-right text-xs">${distanceText}</td>
                        <td class="p-1 text-right text-xs">${result.time}s</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            resultsTable.innerHTML = html;
            roundResults.classList.remove('hidden');

            // Tampilkan next round button untuk host atau info waiting
            if (gameState.isHost) {
                nextRoundBtn.classList.remove('hidden');
                nextRoundInfo.classList.add('hidden');
            } else {
                nextRoundBtn.classList.add('hidden');
                nextRoundInfo.classList.remove('hidden');
            }
        }

        // NEXT ROUND dengan wait system
        function nextRound() {
            if (!gameState.isHost) return;
            
            gameState.currentRound++;
            
            if (gameState.currentRound > gameState.totalRounds) {
                endGame();
                return;
            }

            // Reset round results dan player status
            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (currentLobby) {
                currentLobby.currentRound = gameState.currentRound;
                currentLobby.roundResults = {};
                
                // Reset semua player status ke waiting
                Object.keys(currentLobby.players).forEach(playerId => {
                    currentLobby.players[playerId].status = 'waiting';
                });
                
                saveLobbyToStorage(gameState.lobbyCode, currentLobby);
            }

            startRound();
        }

        // [Fungsi-fungsi lainnya tetap sama...]
        // Untuk menjaga panjang response, saya skip bagian yang repetitive

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
                            </html>
