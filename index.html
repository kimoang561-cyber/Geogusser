<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maps Guesser - Local Maps</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Animasi dan styles */
        @keyframes scorePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .score-pop {
            animation: scorePop 0.5s ease-in-out;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        /* Map container kecil persegi panjang */
        #map {
            height: 300px; /* Diperkecil */
            width: 100%;
            max-width: 500px; /* Lebar maksimal */
            margin: 0 auto;
            cursor: crosshair !important;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .guess-marker {
            background-color: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .answer-marker {
            background-color: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .pulse-marker {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .winner-glow {
            animation: winnerGlow 2s infinite;
        }
        
        @keyframes winnerGlow {
            0% { box-shadow: 0 0 20px gold; }
            50% { box-shadow: 0 0 40px gold; }
            100% { box-shadow: 0 0 20px gold; }
        }
        
        /* Loading styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Map controls kecil */
        .map-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 1000;
            background: white;
            padding: 5px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Game info compact */
        .compact-info {
            font-size: 0.875rem;
            padding: 8px 12px;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Overlay -->
    <div id="globalLoading" class="loading-overlay">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <div class="text-xl">Memuat Game Maps Guesser</div>
            <div id="loadingDetail" class="text-sm mt-2 text-gray-300">Menyiapkan sistem</div>
        </div>
    </div>

    <div id="app" class="min-h-screen flex flex-col hidden">
        <!-- Header Compact -->
        <header class="bg-blue-600 text-white p-3 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">üéØ Maps Guesser</h1>
                <div id="connectionStatus" class="bg-green-500 px-2 py-1 rounded text-xs">
                    ‚úÖ Online
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 container mx-auto p-3">
            <!-- Lobby Screen -->
            <div id="lobbyScreen" class="bg-white rounded-lg shadow-sm p-4">
                <h2 class="text-lg font-bold mb-4 text-center">Lobby Game</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Player Info -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pemain</label>
                            <input type="text" id="playerName" placeholder="Nama Anda" 
                                   class="w-full border border-gray-300 rounded-md p-2 text-sm" 
                                   value="Pemain1" maxlength="15">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kode Lobby</label>
                            <div class="flex space-x-2 mb-1">
                                <input type="text" id="lobbyCode" placeholder="Kode Lobby" 
                                       class="flex-1 border border-gray-300 rounded-md p-2 text-sm"
                                       value="ABC123" maxlength="6">
                                <button id="generateCodeBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 rounded text-sm transition">
                                    üîÑ
                                </button>
                            </div>
                            <button id="joinLobbyBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded text-sm transition">
                                üéÆ Buat/Gabung Lobby
                            </button>
                        </div>
                    </div>
                    
                    <!-- Game Settings -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Ronde</label>
                            <select id="roundsSelect" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                                <option value="3">3 Ronde</option>
                                <option value="5" selected>5 Ronde</option>
                                <option value="7">7 Ronde</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                            <select id="regionSelect" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                                <option value="indonesia">üáÆüá© Indonesia</option>
                                <option value="jawa">üèùÔ∏è Jawa</option>
                                <option value="jogja">üèØ Yogyakarta</option>
                                <option value="bali">üå¥ Bali</option>
                                <option value="sumatra">üåã Sumatra</option>
                                <option value="mexico">üá≤üáΩ Mexico</option>
                                <option value="japan">üáØüáµ Japan</option>
                                <option value="europe">üá™üá∫ Europe</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Players in Lobby -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-md font-bold">Pemain di Lobby (<span id="playerCount">0</span>/5)</h3>
                        <div id="lobbyStatus" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                            üí§ Menunggu
                        </div>
                    </div>
                    <div id="playersList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                        <div class="p-2 bg-gray-100 rounded text-center text-gray-500 text-xs">
                            Belum ada pemain
                        </div>
                    </div>
                </div>
                
                <!-- Lobby Controls -->
                <div class="mt-4 flex space-x-2">
                    <button id="startGameBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded text-sm transition hidden">
                        üöÄ Mulai Game
                    </button>
                    <button id="leaveLobbyBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded text-sm transition hidden">
                        ‚ùå Keluar
                    </button>
                </div>

                <!-- Demo Players -->
                <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                    <h4 class="font-bold mb-2 text-sm">Demo Players:</h4>
                    <div class="flex space-x-1 flex-wrap gap-1">
                        <button id="addDemoPlayer1" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-2 rounded text-xs transition">
                            + Pemain 2
                        </button>
                        <button id="addDemoPlayer2" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-2 rounded text-xs transition">
                            + Pemain 3
                        </button>
                        <button id="addDemoPlayer3" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-2 rounded text-xs transition">
                            + Pemain 4
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="hidden">
                <div class="flex flex-col gap-3">
                    <!-- Map Container Compact -->
                    <div class="bg-white rounded-lg shadow-sm p-3">
                        <div class="text-center mb-2">
                            <div id="roundInfo" class="compact-info bg-blue-600 text-white rounded-lg inline-block px-3">
                                <strong>Ronde <span id="currentRoundDisplay">1</span>/<span id="totalRoundsDisplay">5</span></strong>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <div id="mapLoading" class="loading-overlay hidden">
                                <div class="text-center">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <div class="text-sm">Memuat peta...</div>
                                </div>
                            </div>
                            
                            <!-- Map Controls -->
                            <div class="map-controls">
                                <div class="space-y-1">
                                    <button id="zoomInBtn" class="w-6 h-6 bg-white border border-gray-300 rounded flex items-center justify-center hover:bg-gray-100 text-xs">
                                        +
                                    </button>
                                    <button id="zoomOutBtn" class="w-6 h-6 bg-white border border-gray-300 rounded flex items-center justify-center hover:bg-gray-100 text-xs">
                                        -
                                    </button>
                                </div>
                            </div>

                            <div id="map"></div>
                            
                            <!-- Guess Instructions -->
                            <div id="guessInstructions" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-3 py-1 rounded text-xs">
                                üéØ Klik peta untuk menebak!
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Panel Compact -->
                    <div class="bg-white rounded-lg shadow-sm p-3">
                        <!-- Game Info -->
                        <div class="mb-3 p-2 bg-blue-50 rounded-lg">
                            <div class="flex justify-between items-center text-sm">
                                <span>Ronde: <span id="currentRound">1</span>/<span id="totalRounds">5</span></span>
                                <span>Lobby: <span id="currentLobbyCode">-</span></span>
                            </div>
                            <div class="mt-1 text-xs">
                                <span id="roundTimer" class="bg-yellow-100 px-2 py-1 rounded">‚è±Ô∏è 0s</span>
                            </div>
                        </div>
                        
                        <!-- Location Info -->
                        <div id="locationInfo" class="mb-3 p-2 bg-green-50 rounded-lg">
                            <h3 class="font-bold mb-1 text-sm">üìç Info Lokasi</h3>
                            <div id="locationDetails" class="text-xs">
                                Pilih region dan mulai game!
                            </div>
                        </div>
                        
                        <!-- Game Controls -->
                        <div id="gameControls" class="space-y-2 mb-3">
                            <button id="lockGuessBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded text-sm transition">
                                üîí Kunci Tebakan
                            </button>
                            <div class="flex space-x-2">
                                <button id="hintBtn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-2 px-3 rounded text-sm transition">
                                    üí° Petunjuk (<span id="hintCount">3</span>)
                                </button>
                                <button id="changeViewBtn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2 px-3 rounded text-sm transition">
                                    üîÑ Ganti Peta
                                </button>
                            </div>
                        </div>
                        
                        <!-- Round Result -->
                        <div id="roundResult" class="hidden p-2 bg-gray-100 rounded-lg mb-3">
                            <h3 class="font-bold mb-1 text-sm">üéØ Hasil Ronde</h3>
                            <p id="distanceResult" class="text-xs"></p>
                            <p id="roundScore" class="text-md font-bold"></p>
                        </div>

                        <!-- Players Status Compact -->
                        <div class="mb-3">
                            <h3 class="font-bold mb-1 text-sm">üë• Status Pemain</h3>
                            <div id="playersStatus" class="space-y-1 max-h-24 overflow-y-auto custom-scrollbar text-xs">
                                <!-- Players status will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Round Results Table -->
                <div id="roundResults" class="mt-3 bg-white rounded-lg shadow-sm p-3 hidden">
                    <h3 class="text-md font-bold mb-2">üìä Hasil Ronde</h3>
                    <div id="resultsTable" class="overflow-x-auto text-xs">
                        <!-- Results table will be populated here -->
                    </div>
                    <button id="nextRoundBtn" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded text-sm transition">
                        ‚û°Ô∏è Ronde Berikutnya
                    </button>
                </div>
            </div>

            <!-- Winner Screen -->
            <div id="winnerScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-xs w-full mx-4 text-center winner-glow">
                    <h2 class="text-xl font-bold mb-3 text-yellow-600">üéâ Pemenang! üéâ</h2>
                    <div id="winnerName" class="text-lg font-bold text-blue-600 mb-3"></div>
                    <div id="winnerScore" class="text-md mb-4">Skor: <span class="font-bold">5900</span></div>
                    <p class="text-gray-600 text-sm">Kembali ke lobby dalam <span id="countdown">10</span> detik...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =============================================
        // MAPS GUESSER - Local Maps dengan Daerah Spesifik
        // =============================================

        // Game state
        let gameState = {
            playerId: null,
            playerName: '',
            lobbyCode: '',
            isHost: false,
            currentRound: 0,
            totalRounds: 5,
            score: 0,
            roundScores: [],
            currentLocation: null,
            guessMarker: null,
            answerMarker: null,
            distanceLine: null,
            gameStarted: false,
            roundActive: false,
            hintsUsed: 0,
            maxHints: 3,
            startTime: null,
            map: null,
            selectedRegion: 'indonesia',
            roundTime: 0,
            roundTimer: null,
            players: {},
            currentRoundResults: [],
            currentGuess: null,
            mapInitialized: false
        };

        // DAERAH SPESIFIK dengan koordinat tepat
        const specificLocations = {
            'indonesia': [
                { lat: -6.2088, lng: 106.8456, name: "Monas, Jakarta" },
                { lat: -7.7971, lng: 110.3688, name: "Keraton Yogyakarta" },
                { lat: -8.3405, lng: 115.0920, name: "Pantai Kuta, Bali" },
                { lat: -6.9175, lng: 107.6191, name: "Gedung Sate, Bandung" },
                { lat: -7.2504, lng: 112.7688, name: "Tugu Pahlawan, Surabaya" }
            ],
            'jawa': [
                { lat: -6.2088, lng: 106.8456, name: "Monas Jakarta" },
                { lat: -7.7971, lng: 110.3688, name: "Malioboro Jogja" },
                { lat: -6.9175, lng: 107.6191, name: "Alun-alun Bandung" },
                { lat: -7.2504, lng: 112.7688, name: "Tunjungan Plaza Surabaya" },
                { lat: -6.9667, lng: 110.4167, name: "Simpang Lima Semarang" }
            ],
            'jogja': [
                { lat: -7.7971, lng: 110.3688, name: "Keraton Yogyakarta" },
                { lat: -7.8032, lng: 110.3648, name: "Malioboro Street" },
                { lat: -7.7679, lng: 110.3783, name: "Sleman City Hall" },
                { lat: -7.7828, lng: 110.3909, name: "UGM Kampus" },
                { lat: -7.8075, lng: 110.3712, name: "Benteng Vredeburg" }
            ],
            'bali': [
                { lat: -8.3405, lng: 115.0920, name: "Pantai Kuta" },
                { lat: -8.5193, lng: 115.2633, name: "Pura Uluwatu" },
                { lat: -8.4095, lng: 115.1889, name: "Pasar Seni Sukawati" },
                { lat: -8.5069, lng: 115.2625, name: "GWK Cultural Park" },
                { lat: -8.3738, lng: 115.5029, name: "Pura Besakih" }
            ],
            'sumatra': [
                { lat: 0.7893, lng: 113.9213, name: "Danau Toba" },
                { lat: -0.9471, lng: 100.4166, name: "Jam Gadang Bukittinggi" },
                { lat: 5.5483, lng: 95.3238, name: "Masjid Baiturrahman Banda Aceh" },
                { lat: -2.9909, lng: 104.7566, name: "Ampera Bridge Palembang" },
                { lat: 1.1309, lng: 104.0524, name: "Barelang Bridge Batam" }
            ],
            'mexico': [
                { lat: 19.4326, lng: -99.1332, name: "Zocalo Mexico City" },
                { lat: 20.6597, lng: -103.3496, name: "Guadalajara Cathedral" },
                { lat: 25.6866, lng: -100.3161, name: "Macroplaza Monterrey" },
                { lat: 21.1619, lng: -86.8515, name: "Cancun Beach" },
                { lat: 19.0414, lng: -98.2063, name: "Pyramid of Cholula" }
            ],
            'japan': [
                { lat: 35.6895, lng: 139.6917, name: "Shibuya Crossing Tokyo" },
                { lat: 34.6937, lng: 135.5023, name: "Osaka Castle" },
                { lat: 35.0116, lng: 135.7681, name: "Kinkaku-ji Kyoto" },
                { lat: 43.0618, lng: 141.3545, name: "Sapporo Clock Tower" },
                { lat: 26.2124, lng: 127.6809, name: "Shuri Castle Okinawa" }
            ],
            'europe': [
                { lat: 48.8566, lng: 2.3522, name: "Eiffel Tower Paris" },
                { lat: 51.5074, lng: -0.1278, name: "Big Ben London" },
                { lat: 41.9028, lng: 12.4964, name: "Colosseum Rome" },
                { lat: 52.5200, lng: 13.4050, name: "Brandenburg Gate Berlin" },
                { lat: 40.4168, lng: -3.7038, name: "Puerta del Sol Madrid" }
            ]
        };

        // Region boundaries untuk zoom yang tepat
        const regionBounds = {
            'indonesia': { center: [-2.5489, 118.0149], zoom: 5 },
            'jawa': { center: [-7.6145, 110.7122], zoom: 7 },
            'jogja': { center: [-7.7971, 110.3688], zoom: 12 },
            'bali': { center: [-8.4095, 115.1889], zoom: 10 },
            'sumatra': { center: [-0.5897, 101.3431], zoom: 6 },
            'mexico': { center: [23.6345, -102.5528], zoom: 5 },
            'japan': { center: [36.2048, 138.2529], zoom: 5 },
            'europe': { center: [50.1109, 10.4541], zoom: 4 }
        };

        // DOM Elements
        const globalLoading = document.getElementById('globalLoading');
        const app = document.getElementById('app');
        const loadingDetail = document.getElementById('loadingDetail');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        const winnerScreen = document.getElementById('winnerScreen');
        const playerNameInput = document.getElementById('playerName');
        const lobbyCodeInput = document.getElementById('lobbyCode');
        const generateCodeBtn = document.getElementById('generateCodeBtn');
        const joinLobbyBtn = document.getElementById('joinLobbyBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const leaveLobbyBtn = document.getElementById('leaveLobbyBtn');
        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');
        const lobbyStatus = document.getElementById('lobbyStatus');
        const addDemoPlayer1 = document.getElementById('addDemoPlayer1');
        const addDemoPlayer2 = document.getElementById('addDemoPlayer2');
        const addDemoPlayer3 = document.getElementById('addDemoPlayer3');
        const mapLoading = document.getElementById('mapLoading');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const guessInstructions = document.getElementById('guessInstructions');
        const roundInfo = document.getElementById('roundInfo');
        const currentRoundDisplay = document.getElementById('currentRoundDisplay');
        const totalRoundsDisplay = document.getElementById('totalRoundsDisplay');
        const currentRoundElement = document.getElementById('currentRound');
        const totalRoundsElement = document.getElementById('totalRounds');
        const currentLobbyCode = document.getElementById('currentLobbyCode');
        const roundTimer = document.getElementById('roundTimer');
        const playersStatus = document.getElementById('playersStatus');
        const lockGuessBtn = document.getElementById('lockGuessBtn');
        const hintBtn = document.getElementById('hintBtn');
        const changeViewBtn = document.getElementById('changeViewBtn');
        const hintCountElement = document.getElementById('hintCount');
        const locationInfo = document.getElementById('locationInfo');
        const locationDetails = document.getElementById('locationDetails');
        const roundResultElement = document.getElementById('roundResult');
        const distanceResultElement = document.getElementById('distanceResult');
        const roundScoreElement = document.getElementById('roundScore');
        const roundResults = document.getElementById('roundResults');
        const resultsTable = document.getElementById('resultsTable');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const winnerName = document.getElementById('winnerName');
        const winnerScore = document.getElementById('winnerScore');
        const countdown = document.getElementById('countdown');

        // Initialize application
        async function init() {
            try {
                updateLoadingDetail("Menginisialisasi game...");
                await simulateLoad(1000);

                updateLoadingDetail("Membuat ID player...");
                gameState.playerId = generatePlayerId();
                await simulateLoad(500);

                updateLoadingDetail("Memuat pengaturan...");
                loadSavedSettings();
                await simulateLoad(500);

                updateLoadingDetail("Menyiapkan antarmuka...");
                setupEventListeners();
                await simulateLoad(500);

                // Sembunyikan loading dan tampilkan app
                globalLoading.style.opacity = '0';
                setTimeout(() => {
                    globalLoading.classList.add('hidden');
                    app.classList.remove('hidden');
                }, 500);

            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error inisialisasi: ' + error.message);
            }
        }

        // Simulate loading delay
        function simulateLoad(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Update loading detail text
        function updateLoadingDetail(text) {
            if (loadingDetail) {
                loadingDetail.textContent = text;
            }
        }

        // Generate player ID
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Load saved settings
        function loadSavedSettings() {
            const savedName = localStorage.getItem('mapsGuesserPlayerName');
            if (savedName) {
                playerNameInput.value = savedName;
                gameState.playerName = savedName;
            }
            
            // Generate default lobby code
            lobbyCodeInput.value = generateLobbyCode();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Lobby actions
            generateCodeBtn.addEventListener('click', generateNewLobbyCode);
            joinLobbyBtn.addEventListener('click', joinOrCreateLobby);
            startGameBtn.addEventListener('click', startGame);
            leaveLobbyBtn.addEventListener('click', leaveLobby);
            
            // Demo players
            addDemoPlayer1.addEventListener('click', () => addDemoPlayer(0));
            addDemoPlayer2.addEventListener('click', () => addDemoPlayer(1));
            addDemoPlayer3.addEventListener('click', () => addDemoPlayer(2));
            
            // Game controls
            lockGuessBtn.addEventListener('click', lockGuess);
            hintBtn.addEventListener('click', useHint);
            changeViewBtn.addEventListener('click', changeMapView);
            nextRoundBtn.addEventListener('click', nextRound);
            
            // Map controls
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
        }

        // Generate new lobby code
        function generateNewLobbyCode() {
            lobbyCodeInput.value = generateLobbyCode();
        }

        // Generate lobby code
        function generateLobbyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Join or create lobby
        async function joinOrCreateLobby() {
            const name = playerNameInput.value.trim();
            if (name.length < 2) {
                alert('Nama pemain minimal 2 karakter!');
                return;
            }

            gameState.playerName = name;
            localStorage.setItem('mapsGuesserPlayerName', name);

            const code = lobbyCodeInput.value.trim().toUpperCase();
            if (code.length !== 6) {
                alert('Kode lobby harus 6 karakter!');
                return;
            }

            // Show loading
            joinLobbyBtn.disabled = true;
            joinLobbyBtn.innerHTML = 'üîÑ Memproses...';

            await simulateLoad(1000);

            const existingLobby = getLobbyFromStorage(code);

            if (existingLobby) {
                await joinExistingLobby(code, existingLobby);
            } else {
                await createNewLobby(code);
            }

            joinLobbyBtn.disabled = false;
            joinLobbyBtn.innerHTML = 'üéÆ Buat/Gabung Lobby';
        }

        // Get lobby from storage
        function getLobbyFromStorage(code) {
            try {
                const lobbyData = localStorage.getItem(`lobby_${code}`);
                return lobbyData ? JSON.parse(lobbyData) : null;
            } catch {
                return null;
            }
        }

        // Join existing lobby
        async function joinExistingLobby(code, existingLobby) {
            if (existingLobby.players && Object.keys(existingLobby.players).length >= 5) {
                throw new Error('Lobby sudah penuh! (Maksimal 5 pemain)');
            }

            if (existingLobby.gameState !== 'lobby') {
                throw new Error('Game sudah dimulai di lobby ini!');
            }

            // Add player to lobby
            if (!existingLobby.players) {
                existingLobby.players = {};
            }

            existingLobby.players[gameState.playerId] = {
                name: gameState.playerName,
                score: 0,
                status: 'waiting',
                isHost: false,
                joinTime: Date.now()
            };

            saveLobbyToStorage(code, existingLobby);

            gameState.lobbyCode = code;
            gameState.isHost = false;
            gameState.lobbyData = existingLobby;

            setupLobby();
            alert(`Berhasil bergabung ke lobby ${code}!`);
        }

        // Create new lobby
        async function createNewLobby(code) {
            const lobbyData = {
                code: code,
                host: gameState.playerId,
                players: {
                    [gameState.playerId]: {
                        name: gameState.playerName,
                        score: 0,
                        status: 'waiting',
                        isHost: true,
                        joinTime: Date.now()
                    }
                },
                settings: {
                    rounds: parseInt(document.getElementById('roundsSelect').value),
                    region: document.getElementById('regionSelect').value
                },
                gameState: 'lobby',
                createdTime: Date.now()
            };

            saveLobbyToStorage(code, lobbyData);

            gameState.lobbyCode = code;
            gameState.isHost = true;
            gameState.lobbyData = lobbyData;

            setupLobby();
            alert(`Lobby ${code} berhasil dibuat!`);
        }

        // Save lobby to storage
        function saveLobbyToStorage(code, data) {
            try {
                localStorage.setItem(`lobby_${code}`, JSON.stringify(data));
                return true;
            } catch (error) {
                throw new Error('Gagal menyimpan data lobby');
            }
        }

        // Setup lobby after join/create
        function setupLobby() {
            startGameBtn.classList.remove('hidden');
            leaveLobbyBtn.classList.remove('hidden');
            joinLobbyBtn.classList.add('hidden');
            
            updateLobbyDisplay();
            startLobbyPolling();
        }

        // Update lobby display
        function updateLobbyDisplay() {
            if (!gameState.lobbyData) return;
            
            const players = gameState.lobbyData.players;
            const playerArray = Object.values(players);
            
            playerCount.textContent = playerArray.length;
            updatePlayersList(playerArray);
            
            if (playerArray.length === 1) {
                lobbyStatus.textContent = 'üí§ Menunggu';
                lobbyStatus.className = 'text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded';
            } else if (playerArray.length >= 2) {
                lobbyStatus.textContent = `üëç ${playerArray.length}/5 siap`;
                lobbyStatus.className = 'text-xs bg-green-100 text-green-800 px-2 py-1 rounded';
            }
            
            if (gameState.isHost && playerArray.length >= 1) {
                startGameBtn.classList.remove('hidden');
            }
        }

        // Update players list
        function updatePlayersList(players) {
            playersList.innerHTML = '';
            
            if (players.length === 0) {
                playersList.innerHTML = '<div class="p-2 bg-gray-100 rounded text-center text-gray-500 text-xs">Belum ada pemain</div>';
                return;
            }
            
            players.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = `p-2 rounded text-center text-xs ${
                    player.isHost ? 'bg-blue-100 border border-blue-300' : 'bg-gray-100'
                }`;
                
                playerElement.innerHTML = `
                    <div class="font-bold">${player.name}</div>
                    <div class="text-gray-600 mt-1">${player.isHost ? 'üéÆ Host' : 'üë§ Player'}</div>
                `;
                
                playersList.appendChild(playerElement);
            });
        }

        // Start lobby polling
        function startLobbyPolling() {
            setInterval(() => {
                if (gameState.lobbyCode) {
                    const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
                    if (currentLobby) {
                        gameState.lobbyData = currentLobby;
                        updateLobbyDisplay();

                        // Check if game should start
                        if (currentLobby.gameState === 'playing' && !gameState.gameStarted) {
                            startGameFromLobby();
                        }
                    }
                }
            }, 2000);
        }

        // Add demo player
        function addDemoPlayer(index) {
            if (!gameState.isHost || !gameState.lobbyCode) {
                alert('Anda harus menjadi host di lobby!');
                return;
            }

            const demoPlayers = [
                { id: 'demo1', name: 'Pemain2', score: 0, status: 'waiting' },
                { id: 'demo2', name: 'Pemain3', score: 0, status: 'waiting' },
                { id: 'demo3', name: 'Pemain4', score: 0, status: 'waiting' }
            ];

            const demoPlayer = demoPlayers[index];
            if (!demoPlayer) return;

            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (!currentLobby) return;

            if (currentLobby.players[demoPlayer.id]) {
                alert(`${demoPlayer.name} sudah di lobby!`);
                return;
            }

            if (Object.keys(currentLobby.players).length >= 5) {
                alert('Lobby sudah penuh!');
                return;
            }

            currentLobby.players[demoPlayer.id] = {
                name: demoPlayer.name,
                score: demoPlayer.score,
                status: demoPlayer.status,
                isHost: false,
                isDemo: true,
                joinTime: Date.now()
            };

            saveLobbyToStorage(gameState.lobbyCode, currentLobby);
            gameState.lobbyData = currentLobby;
            
            updateLobbyDisplay();
        }

        // START GAME
        function startGame() {
            if (!gameState.isHost) {
                alert('Hanya host yang bisa memulai game!');
                return;
            }

            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (!currentLobby) return;

            // Update game state to playing
            currentLobby.gameState = 'playing';
            currentLobby.currentRound = 1;
            currentLobby.startTime = Date.now();

            // Update settings from UI
            currentLobby.settings = {
                rounds: parseInt(document.getElementById('roundsSelect').value),
                region: document.getElementById('regionSelect').value
            };

            saveLobbyToStorage(gameState.lobbyCode, currentLobby);
            
            alert('Game dimulai!');
        }

        // Start game from lobby data
        function startGameFromLobby() {
            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (!currentLobby) return;

            gameState.totalRounds = currentLobby.settings.rounds;
            gameState.currentRound = 1;
            gameState.selectedRegion = currentLobby.settings.region;
            gameState.gameStarted = true;

            // Hide lobby, show game screen
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            // Initialize map and start first round
            initMap();
            startRound();

            console.log('Game started successfully!');
        }

        // Initialize map dengan region yang dipilih
        function initMap() {
            mapLoading.classList.remove('hidden');

            setTimeout(() => {
                try {
                    const region = gameState.selectedRegion;
                    const bounds = regionBounds[region] || { center: [0, 0], zoom: 2 };

                    gameState.map = L.map('map', {
                        center: bounds.center,
                        zoom: bounds.zoom,
                        minZoom: bounds.zoom - 2,
                        maxZoom: 18,
                        zoomControl: false
                    });

                    // Gunakan OpenStreetMap standard
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                        maxZoom: 19
                    }).addTo(gameState.map);

                    // Add click listener for guessing
                    gameState.map.on('click', handleMapClick);

                    gameState.mapInitialized = true;
                    mapLoading.classList.add('hidden');

                    console.log(`Map initialized for region: ${region}`);

                } catch (error) {
                    console.error("Error initializing map:", error);
                    mapLoading.innerHTML = 'Error memuat peta';
                }
            }, 1000);
        }

        // Handle map click
        function handleMapClick(e) {
            if (!gameState.roundActive) return;
            
            gameState.currentGuess = e.latlng;
            updateGuessMarker();
            updateLocationInfo(e.latlng);
            
            lockGuessBtn.classList.remove('bg-green-500');
            lockGuessBtn.classList.add('bg-blue-500');
            lockGuessBtn.textContent = '‚úÖ Konfirmasi Tebakan';
        }

        // Update guess marker
        function updateGuessMarker() {
            if (!gameState.currentGuess) return;
            
            if (gameState.guessMarker) {
                gameState.map.removeLayer(gameState.guessMarker);
            }
            
            gameState.guessMarker = L.circleMarker(gameState.currentGuess, {
                radius: 6,
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.7,
                className: 'guess-marker'
            }).addTo(gameState.map);
        }

        // Update location info
        function updateLocationInfo(latlng) {
            const region = gameState.selectedRegion;
            const regionName = getRegionName(region);
            
            locationDetails.innerHTML = `
                <div><strong>Koordinat:</strong> ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}</div>
                <div><strong>Region:</strong> ${regionName}</div>
                <div><strong>Zoom:</strong> ${gameState.map.getZoom()}x</div>
            `;
        }

        // Get region name
        function getRegionName(regionCode) {
            const names = {
                'indonesia': 'Indonesia',
                'jawa': 'Pulau Jawa',
                'jogja': 'Yogyakarta',
                'bali': 'Bali',
                'sumatra': 'Sumatra',
                'mexico': 'Mexico',
                'japan': 'Japan',
                'europe': 'Europe'
            };
            return names[regionCode] || regionCode;
        }

        // Lock guess
        function lockGuess() {
            if (!gameState.currentGuess || !gameState.roundActive) {
                alert('Silakan klik di peta terlebih dahulu untuk menebak!');
                return;
            }
            
            makeGuess(gameState.currentGuess);
        }

        // Start round
        function startRound() {
            if (gameState.currentRound > gameState.totalRounds) {
                endGame();
                return;
            }

            gameState.roundActive = true;
            gameState.hintsUsed = 0;
            gameState.startTime = Date.now();
            gameState.roundTime = 0;
            gameState.currentGuess = null;

            // Clear previous markers
            clearMapOverlays();

            // Hide previous results
            roundResultElement.classList.add('hidden');
            roundResults.classList.add('hidden');

            // Generate random location in selected region
            generateRandomLocation();

            // Update UI
            updateGameUI();
            startRoundTimer();

            // Reset guess button
            lockGuessBtn.classList.remove('bg-blue-500', 'bg-gray-400');
            lockGuessBtn.classList.add('bg-green-500');
            lockGuessBtn.textContent = 'üîí Kunci Tebakan';
            lockGuessBtn.disabled = false;

            console.log(`Round ${gameState.currentRound} started for region: ${gameState.selectedRegion}`);
        }

        // Generate random location dari daftar spesifik
        function generateRandomLocation() {
            const region = gameState.selectedRegion;
            const locations = specificLocations[region];
            
            if (locations && locations.length > 0) {
                // Pilih random location dari daftar spesifik
                const randomLocation = locations[Math.floor(Math.random() * locations.length)];
                gameState.currentLocation = {
                    lat: randomLocation.lat,
                    lng: randomLocation.lng
                };
                
                console.log(`Selected location: ${randomLocation.name}`);
            } else {
                // Fallback ke random location dalam bounds
                const bounds = regionBounds[region];
                const lat = bounds.center[0] + (Math.random() - 0.5) * 10;
                const lng = bounds.center[1] + (Math.random() - 0.5) * 10;
                gameState.currentLocation = { lat, lng };
            }

            // Set map view ke lokasi dengan zoom yang tepat
            const bounds = regionBounds[region];
            gameState.map.setView(bounds.center, bounds.zoom);
        }

        // Start round timer
        function startRoundTimer() {
            if (gameState.roundTimer) {
                clearInterval(gameState.roundTimer);
            }
            
            gameState.roundTimer = setInterval(() => {
                gameState.roundTime++;
                roundTimer.textContent = `‚è±Ô∏è ${gameState.roundTime}s`;
            }, 1000);
        }

        // Make guess
        function makeGuess(guessLocation) {
            if (!gameState.roundActive) return;
            
            gameState.roundActive = false;
            clearInterval(gameState.roundTimer);

            // Calculate distance and score
            const distance = calculateDistance(
                gameState.currentLocation.lat, 
                gameState.currentLocation.lng,
                guessLocation.lat, 
                guessLocation.lng
            );
            
            const roundScore = calculateScore(distance, gameState.roundTime);
            gameState.score += roundScore;
            gameState.roundScores.push(roundScore);

            // Show results
            showRoundResult(guessLocation, distance, roundScore);
            updatePlayerStatus('finished', roundScore);

            console.log(`Guess made - Score: ${roundScore}, Distance: ${distance}m`);
        }

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Calculate score
        function calculateScore(distance, timeSeconds) {
            const baseScore = 5000;
            const maxDistance = 20000000;
            const distancePenalty = Math.min(distance / maxDistance, 1) * baseScore;
            const maxTime = 300;
            const timeBonus = Math.max(0, (maxTime - timeSeconds) / maxTime) * 1000;
            return Math.max(0, baseScore - distancePenalty + timeBonus);
        }

        // Show round result
        function showRoundResult(guessLocation, distance, roundScore) {
            // Show answer marker
            gameState.answerMarker = L.circleMarker(
                [gameState.currentLocation.lat, gameState.currentLocation.lng],
                {
                    radius: 8,
                    color: '#ef4444',
                    fillColor: '#ef4444',
                    fillOpacity: 1,
                    className: 'answer-marker pulse-marker'
                }
            ).addTo(gameState.map).bindTooltip('Lokasi Sebenarnya', { permanent: false });

            // Draw line between guess and answer
            gameState.distanceLine = L.polyline([
                [guessLocation.lat, guessLocation.lng],
                [gameState.currentLocation.lat, gameState.currentLocation.lng]
            ], {
                color: '#ef4444',
                weight: 2,
                opacity: 0.7,
                dashArray: '5, 10'
            }).addTo(gameState.map);

            // Fit map to show both markers
            const group = new L.featureGroup([gameState.guessMarker, gameState.answerMarker]);
            gameState.map.fitBounds(group.getBounds().pad(0.1));

            // Show round result
            const distanceText = distance >= 1000 
                ? `${(distance / 1000).toFixed(2)} km` 
                : `${Math.round(distance)} meter`;
                
            distanceResultElement.textContent = `Jarak: ${distanceText}`;
            roundScoreElement.textContent = `Skor: ${Math.round(roundScore)}`;
            roundScoreElement.classList.add('score-pop');
            roundResultElement.classList.remove('hidden');

            // Show round results after delay
            setTimeout(() => {
                showRoundResults();
            }, 2000);
        }

        // Show round results
        function showRoundResults() {
            // Build simple results table
            let html = `
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-1 text-left text-xs">Pemain</th>
                            <th class="p-1 text-right text-xs">Skor</th>
                            <th class="p-1 text-right text-xs">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Current player result
            html += `
                <tr class="bg-blue-50">
                    <td class="p-1 text-xs">${gameState.playerName} (Anda)</td>
                    <td class="p-1 text-right text-xs">${Math.round(gameState.roundScores[gameState.roundScores.length - 1])}</td>
                    <td class="p-1 text-right text-xs">‚úÖ Selesai</td>
                </tr>
            `;
            
            // Demo players results
            const demoPlayers = ['Pemain2', 'Pemain3', 'Pemain4'];
            demoPlayers.forEach(player => {
                const demoScore = Math.round(2000 + Math.random() * 3000);
                html += `
                    <tr>
                        <td class="p-1 text-xs">${player}</td>
                        <td class="p-1 text-right text-xs">${demoScore}</td>
                        <td class="p-1 text-right text-xs">${Math.random() > 0.3 ? '‚úÖ Selesai' : '‚è≥ Menebak'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            resultsTable.innerHTML = html;
            roundResults.classList.remove('hidden');

            // Show next round button for host
            if (gameState.isHost) {
                nextRoundBtn.classList.remove('hidden');
            }
        }

        // Use hint
        function useHint() {
            if (!gameState.roundActive || gameState.hintsUsed >= gameState.maxHints) return;
            
            gameState.hintsUsed++;
            hintCountElement.textContent = gameState.maxHints - gameState.hintsUsed;
            
            // Zoom out untuk petunjuk
            gameState.map.zoomOut();
            
            if (gameState.hintsUsed >= gameState.maxHints) {
                hintBtn.disabled = true;
                hintBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // Change map view
        function changeMapView() {
            // Simple map style toggle
            if (gameState.map) {
                gameState.map.eachLayer((layer) => {
                    if (layer instanceof L.TileLayer) {
                        gameState.map.removeLayer(layer);
                    }
                });

                // Alternate between different tile providers
                const providers = [
                    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
                    'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'
                ];
                
                const randomProvider = providers[Math.floor(Math.random() * providers.length)];
                
                L.tileLayer(randomProvider, {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(gameState.map);
            }
        }

        // Next round
        function nextRound() {
            if (!gameState.isHost) return;
            
            gameState.currentRound++;
            
            if (gameState.currentRound > gameState.totalRounds) {
                endGame();
                return;
            }

            // Update lobby data
            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (currentLobby) {
                currentLobby.currentRound = gameState.currentRound;
                saveLobbyToStorage(gameState.lobbyCode, currentLobby);
            }

            startRound();
        }

        // End game
        function endGame() {
            // Calculate winner
            const winner = {
                name: gameState.playerName,
                score: Math.round(gameState.score)
            };

            showWinnerScreen(winner);
            
            // Save to leaderboard
            saveToLeaderboard(winner.name, winner.score);
        }

        // Show winner screen
        function showWinnerScreen(winner) {
            winnerName.textContent = winner.name;
            winnerScore.innerHTML = `Skor: <span class="font-bold">${winner.score}</span>`;
            
            winnerScreen.classList.remove('hidden');
            
            // Countdown to return to lobby
            let countdownValue = 10;
            const countdownInterval = setInterval(() => {
                countdownValue--;
                countdown.textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    clearInterval(countdownInterval);
                    returnToLobby();
                }
            }, 1000);
        }

        // Return to lobby
        function returnToLobby() {
            if (gameState.isHost) {
                const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
                if (currentLobby) {
                    currentLobby.gameState = 'lobby';
                    currentLobby.currentRound = 0;
                    saveLobbyToStorage(gameState.lobbyCode, currentLobby);
                }
            }

            // Reset game state
            gameState.score = 0;
            gameState.roundScores = [];
            gameState.currentRound = 0;
            gameState.gameStarted = false;

            // Show lobby screen
            winnerScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
        }

        // Update player status
        function updatePlayerStatus(status, score = null) {
            const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
            if (!currentLobby) return;

            currentLobby.players[gameState.playerId].status = status;
            if (score !== null) {
                currentLobby.players[gameState.playerId].score = gameState.score;
            }

            saveLobbyToStorage(gameState.lobbyCode, currentLobby);
        }

        // Update game UI
        function updateGameUI() {
            currentRoundElement.textContent = gameState.currentRound;
            totalRoundsElement.textContent = gameState.totalRounds;
            currentRoundDisplay.textContent = gameState.currentRound;
            totalRoundsDisplay.textContent = gameState.totalRounds;
            currentLobbyCode.textContent = gameState.lobbyCode;
            hintCountElement.textContent = gameState.maxHints - gameState.hintsUsed;
            
            roundInfo.classList.remove('hidden');
        }

        // Clear map overlays
        function clearMapOverlays() {
            if (gameState.guessMarker) {
                gameState.map.removeLayer(gameState.guessMarker);
                gameState.guessMarker = null;
            }
            
            if (gameState.answerMarker) {
                gameState.map.removeLayer(gameState.answerMarker);
                gameState.answerMarker = null;
            }
            
            if (gameState.distanceLine) {
                gameState.map.removeLayer(gameState.distanceLine);
                gameState.distanceLine = null;
            }
        }

        // Map control functions
        function zoomIn() {
            if (gameState.map) gameState.map.zoomIn();
        }

        function zoomOut() {
            if (gameState.map) gameState.map.zoomOut();
        }

        // Leave lobby
        function leaveLobby() {
            if (gameState.lobbyCode) {
                const currentLobby = getLobbyFromStorage(gameState.lobbyCode);
                if (currentLobby) {
                    delete currentLobby.players[gameState.playerId];
                    
                    if (Object.keys(currentLobby.players).length === 0) {
                        localStorage.removeItem(`lobby_${gameState.lobbyCode}`);
                    } else if (gameState.isHost) {
                        const newHostId = Object.keys(currentLobby.players)[0];
                        currentLobby.players[newHostId].isHost = true;
                        currentLobby.host = newHostId;
                        saveLobbyToStorage(gameState.lobbyCode, currentLobby);
                    }
                }
            }

            resetLobbyState();
            alert('Anda keluar dari lobby');
        }

        // Reset lobby state
        function resetLobbyState() {
            gameState.lobbyCode = '';
            gameState.isHost = false;
            gameState.lobbyData = null;
            
            startGameBtn.classList.add('hidden');
            leaveLobbyBtn.classList.add('hidden');
            joinLobbyBtn.classList.remove('hidden');
            
            playerCount.textContent = '0';
            playersList.innerHTML = '<div class="p-2 bg-gray-100 rounded text-center text-gray-500 text-xs">Belum ada pemain</div>';
            lobbyStatus.textContent = 'üí§ Menunggu';
        }

        // Save to leaderboard
        function saveToLeaderboard(name, score) {
            const leaderboard = JSON.parse(localStorage.getItem('mapsGuesserLeaderboard') || '[]');
            leaderboard.push({
                name: name,
                score: score,
                date: new Date().toISOString()
            });
            leaderboard.sort((a, b) => b.score - a.score);
            if (leaderboard.length > 10) leaderboard.splice(10);
            localStorage.setItem('mapsGuesserLeaderboard', JSON.stringify(leaderboard));
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
    </html>
