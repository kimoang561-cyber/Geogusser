<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maps Guesser - Tebak Lokasi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            min-height: 100vh;
            color: #333;
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .game-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .game-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .game-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .game-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        @media (min-width: 768px) {
            .game-content {
                flex-direction: row;
            }
        }
        
        .map-section {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #eee;
        }
        
        .info-section {
            flex: 0 0 350px;
            padding: 20px;
            background: #f8fafc;
        }
        
        #map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }
        
        .clue-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .clue-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1e293b;
            display: flex;
            align-items: center;
        }
        
        .clue-title i {
            margin-right: 8px;
            color: #f59e0b;
        }
        
        .clue-text {
            font-size: 1rem;
            line-height: 1.5;
            color: #475569;
        }
        
        .game-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .players-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .players-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1e293b;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .player-item:last-child {
            border-bottom: none;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }
        
        .player-info {
            flex: 1;
        }
        
        .player-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        .player-status {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        .player-score {
            font-weight: 700;
            color: #3b82f6;
        }
        
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .result-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .result-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            transform: translateY(20px);
            transition: transform 0.5s ease;
        }
        
        .result-overlay.active .result-card {
            transform: translateY(0);
        }
        
        .result-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1e293b;
        }
        
        .result-distance {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #3b82f6;
        }
        
        .result-score {
            font-size: 2rem;
            font-weight: 700;
            margin: 20px 0;
            color: #10b981;
        }
        
        .result-location {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .difficulty-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .difficulty-easy {
            background: #d1fae5;
            color: #065f46;
        }
        
        .difficulty-medium {
            background: #fef3c7;
            color: #92400e;
        }
        
        .difficulty-hard {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .guess-marker {
            background-color: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        
        .answer-marker {
            background-color: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .distance-line {
            stroke: #ef4444;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
        }
        
        .timer-critical {
            color: #ef4444 !important;
            animation: pulse 0.5s infinite;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">üó∫Ô∏è Maps Guesser</h1>
            <p class="game-subtitle">Uji pengetahuan geografismu! Tebak lokasi berdasarkan petunjuk yang diberikan.</p>
        </div>
        
        <div class="game-card">
            <div class="game-content">
                <div class="map-section">
                    <div id="map"></div>
                    
                    <div class="game-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="round-display">1/5</div>
                            <div class="stat-label">Ronde</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="score-display">0</div>
                            <div class="stat-label">Skor</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="timer-display">30</div>
                            <div class="stat-label">Detik Tersisa</div>
                        </div>
                    </div>
                    
                    <div class="clue-box">
                        <div class="clue-title">
                            <i>üìç</i> Petunjuk Lokasi
                        </div>
                        <div class="clue-text" id="clue-text">
                            Pilih tingkat kesulitan dan mulai permainan!
                        </div>
                        <div id="difficulty-badge" class="difficulty-badge difficulty-medium mt-3">
                            Sedang
                        </div>
                    </div>
                    
                    <div class="game-controls">
                        <button id="lock-guess-btn" class="btn btn-primary">
                            <i>üîí</i> Kunci Tebakan
                        </button>
                        <button id="hint-btn" class="btn btn-secondary">
                            <i>üí°</i> Petunjuk (<span id="hint-count">3</span>)
                        </button>
                    </div>
                    
                    <div class="game-controls">
                        <button id="start-game-btn" class="btn btn-success">
                            <i>üöÄ</i> Mulai Permainan
                        </button>
                        <button id="reset-game-btn" class="btn btn-danger">
                            <i>üîÑ</i> Ulangi
                        </button>
                    </div>
                </div>
                
                <div class="info-section">
                    <div class="players-list">
                        <div class="players-title">Pemain</div>
                        <div id="players-container">
                            <div class="player-item">
                                <div class="player-avatar">A</div>
                                <div class="player-info">
                                    <div class="player-name">Andi</div>
                                    <div class="player-status">Menunggu...</div>
                                </div>
                                <div class="player-score">0</div>
                            </div>
                            <div class="player-item">
                                <div class="player-avatar">B</div>
                                <div class="player-info">
                                    <div class="player-name">Bot 1</div>
                                    <div class="player-status">Menunggu...</div>
                                </div>
                                <div class="player-score">0</div>
                            </div>
                            <div class="player-item">
                                <div class="player-avatar">C</div>
                                <div class="player-info">
                                    <div class="player-name">Bot 2</div>
                                    <div class="player-status">Menunggu...</div>
                                </div>
                                <div class="player-score">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="clue-box mt-4">
                        <div class="clue-title">
                            <i>üèÜ</i> Papan Peringkat
                        </div>
                        <div id="leaderboard" class="mt-2">
                            <div class="player-item">
                                <div class="player-avatar" style="background: #f59e0b;">1</div>
                                <div class="player-info">
                                    <div class="player-name">Wira</div>
                                </div>
                                <div class="player-score">2450</div>
                            </div>
                            <div class="player-item">
                                <div class="player-avatar" style="background: #94a3b8;">2</div>
                                <div class="player-info">
                                    <div class="player-name">Budi</div>
                                </div>
                                <div class="player-score">1890</div>
                            </div>
                            <div class="player-item">
                                <div class="player-avatar" style="background: #a16207;">3</div>
                                <div class="player-info">
                                    <div class="player-name">Sari</div>
                                </div>
                                <div class="player-score">1560</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="result-overlay" id="result-overlay">
        <div class="result-card">
            <h2 class="result-title" id="result-title">Hasil Ronde</h2>
            <div class="result-distance" id="result-distance">Jarak: 0.0 km</div>
            <div class="result-score" id="result-score">+0 Poin</div>
            <div class="result-location" id="result-location">Lokasi: ...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <button id="next-round-btn" class="btn btn-primary" style="width: 100%;">
                <i>‚û°Ô∏è</i> Ronde Berikutnya
            </button>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            currentRound: 1,
            totalRounds: 5,
            score: 0,
            roundActive: false,
            currentLocation: null,
            currentGuess: null,
            map: null,
            guessMarker: null,
            answerMarker: null,
            distanceLine: null,
            timer: null,
            timeLeft: 30,
            hintsUsed: 0,
            maxHints: 3,
            players: [
                { id: 1, name: "Andi", score: 0, status: "waiting", isBot: false },
                { id: 2, name: "Bot 1", score: 0, status: "waiting", isBot: true },
                { id: 3, name: "Bot 2", score: 0, status: "waiting", isBot: true }
            ],
            locations: {
                jogja: [
                    { lat: -7.797068, lng: 110.370529, name: "Keraton Yogyakarta", clue: "Istana resmi Kesultanan Yogyakarta yang masih berfungsi", difficulty: "easy" },
                    { lat: -7.803134, lng: 110.364919, name: "Malioboro", clue: "Jalan terkenal dengan pedagang kaki lima dan andong", difficulty: "easy" },
                    { lat: -7.767911, lng: 110.378251, name: "Sleman City Hall", clue: "Kantor pemerintahan kabupaten Sleman", difficulty: "medium" },
                    { lat: -7.782849, lng: 110.390867, name: "Kampus UGM", clue: "Universitas negeri terbesar di Yogyakarta", difficulty: "medium" },
                    { lat: -7.759586, lng: 110.408024, name: "Sleman City Mall", clue: "Mall terbesar di kawasan Sleman dengan banyak toko", difficulty: "hard" },
                    { lat: -7.824863, lng: 110.388794, name: "Candi Prambanan", clue: "Kompleks candi Hindu terbesar di Indonesia", difficulty: "hard" }
                ],
                bali: [
                    { lat: -8.340539, lng: 115.091950, name: "Beachwalk Mall", clue: "Mall di tepi pantai Kuta dengan view laut", difficulty: "easy" },
                    { lat: -8.722916, lng: 115.172485, name: "Pantai Pandawa", clue: "Pantai dengan tebing kapur dan patung Pandawa", difficulty: "medium" },
                    { lat: -8.519268, lng: 115.263023, name: "GWK Cultural Park", clue: "Taman budaya dengan patung raksasa", difficulty: "hard" }
                ],
                jakarta: [
                    { lat: -6.208763, lng: 106.845599, name: "Monas", clue: "Monumen nasional dengan api emas di puncaknya", difficulty: "easy" },
                    { lat: -6.227906, lng: 106.808923, name: "Grand Indonesia", clue: "Mall mewah di bundaran HI", difficulty: "medium" },
                    { lat: -6.125634, lng: 106.833236, name: "Kota Tua", clue: "Kawasan bersejarah dengan bangunan kolonial Belanda", difficulty: "hard" }
                ]
            },
            currentRegion: 'jogja'
        };

        // DOM Elements
        const mapElement = document.getElementById('map');
        const roundDisplay = document.getElementById('round-display');
        const scoreDisplay = document.getElementById('score-display');
        const timerDisplay = document.getElementById('timer-display');
        const clueText = document.getElementById('clue-text');
        const difficultyBadge = document.getElementById('difficulty-badge');
        const hintCount = document.getElementById('hint-count');
        const lockGuessBtn = document.getElementById('lock-guess-btn');
        const hintBtn = document.getElementById('hint-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const playersContainer = document.getElementById('players-container');
        const resultOverlay = document.getElementById('result-overlay');
        const resultTitle = document.getElementById('result-title');
        const resultDistance = document.getElementById('result-distance');
        const resultScore = document.getElementById('result-score');
        const resultLocation = document.getElementById('result-location');
        const progressFill = document.getElementById('progress-fill');
        const nextRoundBtn = document.getElementById('next-round-btn');

        // Initialize the game
        function initGame() {
            // Initialize map
            gameState.map = L.map('map').setView([-7.7971, 110.3688], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(gameState.map);
            
            // Add click listener for guessing
            gameState.map.on('click', function(e) {
                if (gameState.roundActive) {
                    handleMapClick(e.latlng);
                }
            });
            
            // Set up event listeners
            lockGuessBtn.addEventListener('click', lockGuess);
            hintBtn.addEventListener('click', useHint);
            startGameBtn.addEventListener('click', startGame);
            resetGameBtn.addEventListener('click', resetGame);
            nextRoundBtn.addEventListener('click', nextRound);
            
            // Update UI
            updateUI();
        }

        // Update UI elements
        function updateUI() {
            roundDisplay.textContent = `${gameState.currentRound}/${gameState.totalRounds}`;
            scoreDisplay.textContent = gameState.score;
            timerDisplay.textContent = gameState.timeLeft;
            hintCount.textContent = gameState.maxHints - gameState.hintsUsed;
            
            // Update players list
            updatePlayersList();
        }

        // Update players list
        function updatePlayersList() {
            playersContainer.innerHTML = '';
            
            gameState.players.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                
                const firstLetter = player.name.charAt(0).toUpperCase();
                const statusText = gameState.roundActive ? 
                    (player.status === 'finished' ? '‚úÖ Selesai' : 'üéØ Menebak...') : 
                    'Menunggu...';
                
                playerElement.innerHTML = `
                    <div class="player-avatar">${firstLetter}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-status">${statusText}</div>
                    </div>
                    <div class="player-score">${player.score}</div>
                `;
                
                playersContainer.appendChild(playerElement);
            });
        }

        // Handle map click for guessing
        function handleMapClick(latlng) {
            if (!gameState.roundActive) return;
            
            gameState.currentGuess = latlng;
            
            // Remove previous guess marker
            if (gameState.guessMarker) {
                gameState.map.removeLayer(gameState.guessMarker);
            }
            
            // Add new guess marker
            gameState.guessMarker = L.circleMarker(latlng, {
                radius: 8,
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.7,
                className: 'guess-marker'
            }).addTo(gameState.map);
            
            // Enable lock button with visual feedback
            lockGuessBtn.classList.remove('btn-primary');
            lockGuessBtn.classList.add('btn-success');
            lockGuessBtn.innerHTML = '<i>‚úÖ</i> Konfirmasi Tebakan';
        }

        // Lock in the guess
        function lockGuess() {
            if (!gameState.currentGuess || !gameState.roundActive) {
                alert('Silakan klik peta terlebih dahulu untuk menebak!');
                return;
            }
            
            endRound();
        }

        // Use a hint
        function useHint() {
            if (gameState.hintsUsed >= gameState.maxHints || !gameState.roundActive) {
                alert('Tidak ada petunjuk tersisa!');
                return;
            }
            
            gameState.hintsUsed++;
            updateUI();
            
            // Show a hint (zoom to general area)
            if (gameState.currentLocation) {
                gameState.map.setView([gameState.currentLocation.lat, gameState.currentLocation.lng], 11);
            }
            
            alert(`Petunjuk digunakan! Sekarang tersisa ${gameState.maxHints - gameState.hintsUsed} petunjuk.`);
        }

        // Start the game
        function startGame() {
            gameState.currentRound = 1;
            gameState.score = 0;
            gameState.roundActive = true;
            
            // Reset players
            gameState.players.forEach(player => {
                player.score = 0;
                player.status = 'guessing';
            });
            
            // Start first round
            startRound();
            
            // Update UI
            updateUI();
            startGameBtn.disabled = true;
        }

        // Start a new round
        function startRound() {
            if (gameState.currentRound > gameState.totalRounds) {
                endGame();
                return;
            }
            
            gameState.roundActive = true;
            gameState.currentGuess = null;
            gameState.hintsUsed = 0;
            gameState.timeLeft = 30;
            
            // Clear previous markers and line
            clearMapOverlays();
            
            // Hide result overlay
            resultOverlay.classList.remove('active');
            
            // Select random location
            const regionLocations = gameState.locations[gameState.currentRegion];
            const randomIndex = Math.floor(Math.random() * regionLocations.length);
            gameState.currentLocation = regionLocations[randomIndex];
            
            // Update UI with location clue
            clueText.textContent = gameState.currentLocation.clue;
            
            // Update difficulty badge
            updateDifficultyBadge(gameState.currentLocation.difficulty);
            
            // Reset map view
            gameState.map.setView([-7.7971, 110.3688], 13);
            
            // Reset lock button
            lockGuessBtn.classList.remove('btn-success');
            lockGuessBtn.classList.add('btn-primary');
            lockGuessBtn.innerHTML = '<i>üîí</i> Kunci Tebakan';
            
            // Start timer
            startTimer();
            
            // Update players status
            gameState.players.forEach(player => {
                player.status = 'guessing';
            });
            updatePlayersList();
            
            // Update UI
            updateUI();
        }

        // Update difficulty badge
        function updateDifficultyBadge(difficulty) {
            difficultyBadge.className = 'difficulty-badge';
            
            switch(difficulty) {
                case 'easy':
                    difficultyBadge.classList.add('difficulty-easy');
                    difficultyBadge.textContent = 'Mudah';
                    break;
                case 'medium':
                    difficultyBadge.classList.add('difficulty-medium');
                    difficultyBadge.textContent = 'Sedang';
                    break;
                case 'hard':
                    difficultyBadge.classList.add('difficulty-hard');
                    difficultyBadge.textContent = 'Sulit';
                    break;
            }
        }

        // Start the round timer
        function startTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                timerDisplay.textContent = gameState.timeLeft;
                
                // Visual feedback for low time
                if (gameState.timeLeft <= 10) {
                    timerDisplay.classList.add('timer-critical');
                } else {
                    timerDisplay.classList.remove('timer-critical');
                }
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    if (gameState.roundActive) {
                        autoSubmitGuess();
                    }
                }
            }, 1000);
        }

        // Auto submit when time runs out
        function autoSubmitGuess() {
            if (!gameState.currentGuess && gameState.roundActive) {
                // If no guess was made, pick a random location
                const bounds = gameState.map.getBounds();
                const northEast = bounds.getNorthEast();
                const southWest = bounds.getSouthWest();
                
                const randomLat = southWest.lat + Math.random() * (northEast.lat - southWest.lat);
                const randomLng = southWest.lng + Math.random() * (northEast.lng - southWest.lng);
                
                gameState.currentGuess = { lat: randomLat, lng: randomLng };
                
                // Add a marker at the random guess
                gameState.guessMarker = L.circleMarker(gameState.currentGuess, {
                    radius: 8,
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.7,
                    className: 'guess-marker'
                }).addTo(gameState.map);
            }
            
            endRound();
        }

        // End the current round
        function endRound() {
            gameState.roundActive = false;
            clearInterval(gameState.timer);
            
            // Calculate distance and score
            const distance = calculateDistance(
                gameState.currentGuess.lat, 
                gameState.currentGuess.lng,
                gameState.currentLocation.lat, 
                gameState.currentLocation.lng
            );
            
            const roundScore = calculateScore(distance, gameState.currentLocation.difficulty);
            gameState.score += roundScore;
            
            // Update player score
            gameState.players[0].score = gameState.score;
            gameState.players[0].status = 'finished';
            
            // Simulate bot guesses
            simulateBotGuesses();
            
            // Show answer marker
            gameState.answerMarker = L.circleMarker([gameState.currentLocation.lat, gameState.currentLocation.lng], {
                radius: 8,
                color: '#ef4444',
                fillColor: '#ef4444',
                fillOpacity: 0.7,
                className: 'answer-marker'
            }).addTo(gameState.map);
            
            // Draw distance line
            if (window.L && gameState.currentGuess) {
                const latlngs = [
                    [gameState.currentGuess.lat, gameState.currentGuess.lng],
                    [gameState.currentLocation.lat, gameState.currentLocation.lng]
                ];
                
                gameState.distanceLine = L.polyline(latlngs, {
                    color: '#ef4444',
                    weight: 2,
                    dashArray: '5, 5',
                    className: 'distance-line'
                }).addTo(gameState.map);
            }
            
            // Show results
            showRoundResults(distance, roundScore);
        }

        // Calculate distance between two points in km
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance;
        }

        // Calculate score based on distance and difficulty
        function calculateScore(distance, difficulty) {
            let maxScore;
            
            switch(difficulty) {
                case 'easy':
                    maxScore = 100;
                    break;
                case 'medium':
                    maxScore = 200;
                    break;
                case 'hard':
                    maxScore = 300;
                    break;
                default:
                    maxScore = 150;
            }
            
            // Score decreases with distance
            let score = Math.max(0, maxScore - Math.floor(distance * 10));
            
            // Ensure minimum score of 10
            return Math.max(10, score);
        }

        // Simulate bot guesses
        function simulateBotGuesses() {
            for (let i = 1; i < gameState.players.length; i++) {
                const player = gameState.players[i];
                
                if (player.isBot && player.status === 'guessing') {
                    // Bots have different accuracy based on difficulty
                    let accuracy;
                    
                    switch(gameState.currentLocation.difficulty) {
                        case 'easy':
                            accuracy = 0.8; // 80% chance of good guess
                            break;
                        case 'medium':
                            accuracy = 0.6; // 60% chance of good guess
                            break;
                        case 'hard':
                            accuracy = 0.4; // 40% chance of good guess
                            break;
                    }
                    
                    let botDistance;
                    if (Math.random() < accuracy) {
                        // Good guess - close to actual location
                        botDistance = Math.random() * 2; // Within 2 km
                    } else {
                        // Bad guess - further away
                        botDistance = 5 + Math.random() * 15; // 5-20 km away
                    }
                    
                    // Calculate bot score
                    const botScore = calculateScore(botDistance, gameState.currentLocation.difficulty);
                    player.score += botScore;
                    player.status = 'finished';
                }
            }
            
            updatePlayersList();
        }

        // Show round results
        function showRoundResults(distance, score) {
            resultTitle.textContent = `Hasil Ronde ${gameState.currentRound}`;
            resultDistance.textContent = `Jarak: ${distance.toFixed(2)} km`;
            resultScore.textContent = `+${score} Poin`;
            resultLocation.textContent = `Lokasi: ${gameState.currentLocation.name}`;
            
            // Calculate progress for progress bar
            const progress = (gameState.currentRound / gameState.totalRounds) * 100;
            progressFill.style.width = `${progress}%`;
            
            // Show result overlay
            resultOverlay.classList.add('active');
        }

        // Move to next round
        function nextRound() {
            gameState.currentRound++;
            startRound();
        }

        // End the game
        function endGame() {
            gameState.roundActive = false;
            clearInterval(gameState.timer);
            
            // Show final results
            resultTitle.textContent = 'Permainan Selesai!';
            resultDistance.textContent = '';
            resultScore.textContent = `Skor Akhir: ${gameState.score}`;
            resultLocation.textContent = `Selamat! Anda menyelesaikan ${gameState.totalRounds} ronde.`;
            progressFill.style.width = '100%';
            
            nextRoundBtn.textContent = 'Main Lagi';
            nextRoundBtn.onclick = resetGame;
            
            resultOverlay.classList.add('active');
            startGameBtn.disabled = false;
        }

        // Reset the game
        function resetGame() {
            gameState.currentRound = 1;
            gameState.score = 0;
            gameState.roundActive = false;
            
            // Reset players
            gameState.players.forEach(player => {
                player.score = 0;
                player.status = 'waiting';
            });
            
            // Clear map
            clearMapOverlays();
            
            // Reset UI
            clueText.textContent = 'Pilih tingkat kesulitan dan mulai permainan!';
            updateDifficultyBadge('medium');
            gameState.map.setView([-7.7971, 110.3688], 13);
            
            // Hide result overlay
            resultOverlay.classList.remove('active');
            
            // Update UI
            updateUI();
            startGameBtn.disabled = false;
            
            // Reset next round button
            nextRoundBtn.textContent = 'Ronde Berikutnya';
            nextRoundBtn.onclick = nextRound;
        }

        // Clear map overlays (markers and lines)
        function clearMapOverlays() {
            if (gameState.guessMarker) {
                gameState.map.removeLayer(gameState.guessMarker);
                gameState.guessMarker = null;
            }
            
            if (gameState.answerMarker) {
                gameState.map.removeLayer(gameState.answerMarker);
                gameState.answerMarker = null;
            }
            
            if (gameState.distanceLine) {
                gameState.map.removeLayer(gameState.distanceLine);
                gameState.distanceLine = null;
            }
        }

        // Initialize the game when the page loads
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
