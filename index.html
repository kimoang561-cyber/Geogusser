<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maps Guesser - Enhanced Map</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Fullscreen -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-fullscreen/dist/leaflet.fullscreen.css" />
    <script src="https://unpkg.com/leaflet-fullscreen/dist/Leaflet.fullscreen.min.js"></script>
    
    <!-- Leaflet Motion -->
    <script src="https://unpkg.com/leaflet.motion/dist/leaflet.motion.min.js"></script>

    <style>
        /* Animasi sederhana untuk notifikasi skor */
        @keyframes scorePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .score-pop {
            animation: scorePop 0.5s ease-in-out;
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Style untuk map container */
        #map {
            height: 100%;
            width: 100%;
            cursor: crosshair !important;
        }
        
        /* Custom marker styles */
        .guess-marker {
            background-color: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .answer-marker {
            background-color: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .pulse-marker {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Winner animation */
        @keyframes winnerGlow {
            0% { box-shadow: 0 0 20px gold; }
            50% { box-shadow: 0 0 40px gold; }
            100% { box-shadow: 0 0 20px gold; }
        }
        
        .winner-glow {
            animation: winnerGlow 2s infinite;
        }
        
        /* Player status colors */
        .player-waiting { background-color: #fbbf24; }
        .player-guessing { background-color: #3b82f6; }
        .player-finished { background-color: #10b981; }
        
        /* Connection status */
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-local { background-color: #f59e0b; }
        
        /* Map controls */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        /* Crosshair cursor for map */
        .leaflet-container {
            cursor: crosshair !important;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            color: white;
            font-size: 1.5rem;
        }
        
        /* Street View style container */
        .street-view-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        /* 3D building layer */
        .building-layer {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Maps Guesser - Enhanced Map</h1>
                <div id="connectionStatus" class="status-local px-3 py-1 rounded text-sm">
                    Local Network
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 container mx-auto p-4">
            <!-- Lobby Screen -->
            <div id="lobbyScreen" class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-6 text-center">Lobby Game</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Player Info -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pemain</label>
                            <input type="text" id="playerName" placeholder="Masukkan nama Anda" 
                                   class="w-full border border-gray-300 rounded-md p-3 text-lg" maxlength="15"
                                   value="Pemain1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Buat atau Gabung Lobby</label>
                            <input type="text" id="lobbyCode" placeholder="Kode Lobby (kosongkan untuk buat baru)" 
                                   class="w-full border border-gray-300 rounded-md p-3 mb-2"
                                   value="ABC123">
                            <button id="joinLobbyBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded transition">
                                Buat/Gabung Lobby
                            </button>
                        </div>
                    </div>
                    
                    <!-- Game Settings -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Ronde</label>
                            <select id="roundsSelect" class="w-full border border-gray-300 rounded-md p-3">
                                <option value="3">3 Ronde</option>
                                <option value="5" selected>5 Ronde</option>
                                <option value="7">7 Ronde</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mode Peta</label>
                            <select id="mapTypeSelect" class="w-full border border-gray-300 rounded-md p-3">
                                <option value="streets">Street View</option>
                                <option value="satellite">Satellite 3D</option>
                                <option value="terrain">Topography</option>
                                <option value="hybrid">Hybrid</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Region</label>
                            <select id="regionSelect" class="w-full border border-gray-300 rounded-md p-3">
                                <option value="world">Seluruh Dunia</option>
                                <option value="asia">Asia</option>
                                <option value="europe">Eropa</option>
                                <option value="north-america">Amerika Utara</option>
                                <option value="south-america">Amerika Selatan</option>
                                <option value="africa">Afrika</option>
                                <option value="oceania">Oseania</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Players in Lobby -->
                <div class="mt-8">
                    <h3 class="text-lg font-bold mb-4">Pemain di Lobby (<span id="playerCount">0</span>/5)</h3>
                    <div id="playersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                        <!-- Players will be listed here -->
                    </div>
                </div>
                
                <!-- Lobby Controls -->
                <div class="mt-6 flex space-x-4">
                    <button id="startGameBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded transition hidden">
                        Mulai Game
                    </button>
                    <button id="leaveLobbyBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded transition hidden">
                        Keluar Lobby
                    </button>
                </div>

                <!-- Demo Players (for testing) -->
                <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                    <h4 class="font-bold mb-2">Demo Multiplayer (Testing):</h4>
                    <div class="flex space-x-2">
                        <button id="addDemoPlayer1" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded text-sm">
                            Tambah Pemain 2
                        </button>
                        <button id="addDemoPlayer2" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded text-sm">
                            Tambah Pemain 3
                        </button>
                        <button id="addDemoPlayer3" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded text-sm">
                            Tambah Pemain 4
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="hidden relative">
                <!-- Map Controls -->
                <div class="map-controls">
                    <div class="space-y-2">
                        <button id="zoomInBtn" class="w-8 h-8 bg-white border border-gray-300 rounded flex items-center justify-center hover:bg-gray-100">
                            <span class="text-lg font-bold">+</span>
                        </button>
                        <button id="zoomOutBtn" class="w-8 h-8 bg-white border border-gray-300 rounded flex items-center justify-center hover:bg-gray-100">
                            <span class="text-lg font-bold">-</span>
                        </button>
                        <button id="fullscreenBtn" class="w-8 h-8 bg-white border border-gray-300 rounded flex items-center justify-center hover:bg-gray-100">
                            <span class="text-sm">‚õ∂</span>
                        </button>
                    </div>
                </div>

                <!-- Street View Info -->
                <div id="streetViewInfo" class="street-view-container hidden">
                    <div>üéØ <strong>Street View Mode</strong></div>
                    <div>Klik di peta untuk menebak lokasi!</div>
                </div>

                <div class="flex flex-col lg:flex-row gap-4">
                    <!-- Map Container -->
                    <div class="flex-1 bg-white rounded-lg shadow-md overflow-hidden relative">
                        <div id="mapLoading" class="loading-overlay hidden">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                                <div>Memuat peta...</div>
                            </div>
                        </div>
                        <div id="map" class="w-full h-96 lg:h-full"></div>
                        
                        <!-- Guess Instructions -->
                        <div id="guessInstructions" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-4 py-2 rounded-lg text-sm hidden">
                            üéØ <strong>Klik di mana saja di peta untuk menebak lokasi!</strong>
                        </div>
                    </div>
                    
                    <!-- Game Panel -->
                    <div class="w-full lg:w-80 bg-white rounded-lg shadow-md p-4 flex flex-col">
                        <!-- Game Info -->
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="font-bold">Ronde: <span id="currentRound">1</span>/<span id="totalRounds">5</span></span>
                                <span class="font-bold">Lobby: <span id="currentLobbyCode">-</span></span>
                            </div>
                            <div class="mt-2 text-sm">
                                <span id="roundTimer" class="bg-yellow-100 px-2 py-1 rounded">Waktu: 0s</span>
                            </div>
                        </div>
                        
                        <!-- Location Info -->
                        <div id="locationInfo" class="mb-4 p-3 bg-green-50 rounded-lg hidden">
                            <h3 class="font-bold mb-2">üìç Info Lokasi</h3>
                            <div id="locationDetails" class="text-sm">
                                Sedang memuat informasi lokasi...
                            </div>
                        </div>
                        
                        <!-- Players Status -->
                        <div class="mb-4">
                            <h3 class="font-bold mb-2">Status Pemain</h3>
                            <div id="playersStatus" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                <!-- Players status will be shown here -->
                            </div>
                        </div>
                        
                        <!-- Game Controls -->
                        <div id="gameControls" class="space-y-3 mb-6">
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <p class="text-sm text-yellow-800">
                                    <strong>üí° Cara Main:</strong> Telusuri peta dan klik untuk menebak lokasi!
                                </p>
                            </div>
                            <button id="lockGuessBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition">
                                üîí Kunci Tebakan Sekarang
                            </button>
                            <button id="hintBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded transition">
                                Gunakan Petunjuk (<span id="hintCount">3</span> tersisa)
                            </button>
                            <button id="panoramaBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition">
                                üèôÔ∏è Tampilkan Street View
                            </button>
                        </div>
                        
                        <!-- Round Result -->
                        <div id="roundResult" class="hidden p-3 bg-gray-100 rounded-lg mb-4">
                            <h3 class="font-bold text-lg mb-2">Hasil Ronde</h3>
                            <p id="distanceResult" class="text-sm"></p>
                            <p id="roundScore" class="text-lg font-bold"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Round Results Table -->
                <div id="roundResults" class="mt-4 bg-white rounded-lg shadow-md p-4 hidden">
                    <h3 class="text-lg font-bold mb-3">Hasil Ronde Ini</h3>
                    <div id="resultsTable" class="overflow-x-auto">
                        <!-- Results table will be populated here -->
                    </div>
                    <button id="nextRoundBtn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition">
                        Ronde Berikutnya
                    </button>
                </div>
            </div>

            <!-- Winner Screen -->
            <div id="winnerScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 text-center winner-glow">
                    <h2 class="text-3xl font-bold mb-4 text-yellow-600">üéâ Pemenang! üéâ</h2>
                    <div id="winnerName" class="text-2xl font-bold text-blue-600 mb-4"></div>
                    <div id="winnerScore" class="text-xl mb-6">Skor: <span class="font-bold">5900</span></div>
                    <p class="text-gray-600">Kembali ke lobby dalam <span id="countdown">10</span> detik...</p>
                </div>
            </div>
        </main>
        
        <!-- Leaderboard -->
        <aside class="container mx-auto p-4">
            <div class="bg-white rounded-lg shadow-md p-4">
                <h2 class="text-xl font-bold mb-4">Leaderboard</h2>
                <div id="leaderboard" class="custom-scrollbar max-h-64 overflow-y-auto">
                    <!-- Leaderboard entries will be populated here -->
                </div>
            </div>
        </aside>
    </div>

    <script>
        // =============================================
        // MAPS GUESSER - Enhanced Map Version
        // Map yang lebih interaktif seperti Google Earth
        // =============================================

        // Game state
        let gameState = {
            playerId: null,
            playerName: '',
            lobbyCode: '',
            isHost: false,
            currentRound: 0,
            totalRounds: 5,
            score: 0,
            roundScores: [],
            currentLocation: null,
            guessMarker: null,
            answerMarker: null,
            distanceLine: null,
            gameStarted: false,
            roundActive: false,
            hintsUsed: 0,
            maxHints: 3,
            startTime: null,
            map: null,
            selectedRegion: 'world',
            roundTime: 0,
            roundTimer: null,
            players: {},
            currentRoundResults: [],
            currentGuess: null,
            mapInitialized: false
        };

        // Enhanced Map tile providers
        const mapProviders = {
            streets: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            },
            satellite: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            },
            terrain: {
                url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            },
            hybrid: {
                url: 'https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',
                attribution: '&copy; Google',
                maxZoom: 20,
                subdomains: ['mt0','mt1','mt2','mt3']
            }
        };

        // Region boundaries dengan lokasi menarik
        const regions = {
            'world': { 
                minLat: -90, maxLat: 90, minLng: -180, maxLng: 180,
                interestingLocations: [
                    { lat: 40.7128, lng: -74.0060, name: "New York" },
                    { lat: 51.5074, lng: -0.1278, name: "London" },
                    { lat: 35.6762, lng: 139.6503, name: "Tokyo" },
                    { lat: -33.8688, lng: 151.2093, name: "Sydney" }
                ]
            },
            'asia': { 
                minLat: -10, maxLat: 80, minLng: 25, maxLng: 180,
                interestingLocations: [
                    { lat: 35.6762, lng: 139.6503, name: "Tokyo" },
                    { lat: 1.3521, lng: 103.8198, name: "Singapore" },
                    { lat: 22.3193, lng: 114.1694, name: "Hong Kong" },
                    { lat: 13.7563, lng: 100.5018, name: "Bangkok" }
                ]
            },
            'europe': { 
                minLat: 35, maxLat: 72, minLng: -25, maxLng: 60,
                interestingLocations: [
                    { lat: 51.5074, lng: -0.1278, name: "London" },
                    { lat: 48.8566, lng: 2.3522, name: "Paris" },
                    { lat: 52.5200, lng: 13.4050, name: "Berlin" },
                    { lat: 41.9028, lng: 12.4964, name: "Rome" }
                ]
            },
            'north-america': { 
                minLat: 5, maxLat: 85, minLng: -170, maxLng: -50,
                interestingLocations: [
                    { lat: 40.7128, lng: -74.0060, name: "New York" },
                    { lat: 34.0522, lng: -118.2437, name: "Los Angeles" },
                    { lat: 43.6532, lng: -79.3832, name: "Toronto" },
                    { lat: 19.4326, lng: -99.1332, name: "Mexico City" }
                ]
            },
            'south-america': { 
                minLat: -55, maxLat: 15, minLng: -85, maxLng: -30,
                interestingLocations: [
                    { lat: -23.5505, lng: -46.6333, name: "Sao Paulo" },
                    { lat: -34.6037, lng: -58.3816, name: "Buenos Aires" },
                    { lat: -12.0464, lng: -77.0428, name: "Lima" },
                    { lat: -33.4489, lng: -70.6693, name: "Santiago" }
                ]
            },
            'africa': { 
                minLat: -35, maxLat: 38, minLng: -25, maxLng: 55,
                interestingLocations: [
                    { lat: -26.2041, lng: 28.0473, name: "Johannesburg" },
                    { lat: 30.0444, lng: 31.2357, name: "Cairo" },
                    { lat: 6.5244, lng: 3.3792, name: "Lagos" },
                    { lat: -1.2921, lng: 36.8219, name: "Nairobi" }
                ]
            },
            'oceania': { 
                minLat: -50, maxLat: 0, minLng: 110, maxLng: 180,
                interestingLocations: [
                    { lat: -33.8688, lng: 151.2093, name: "Sydney" },
                    { lat: -37.8136, lng: 144.9631, name: "Melbourne" },
                    { lat: -36.8485, lng: 174.7633, name: "Auckland" },
                    { lat: -41.2865, lng: 174.7762, name: "Wellington" }
                ]
            }
        };

        // DOM Elements
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        const winnerScreen = document.getElementById('winnerScreen');
        const playerNameInput = document.getElementById('playerName');
        const lobbyCodeInput = document.getElementById('lobbyCode');
        const joinLobbyBtn = document.getElementById('joinLobbyBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const leaveLobbyBtn = document.getElementById('leaveLobbyBtn');
        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');
        const roundsSelect = document.getElementById('roundsSelect');
        const mapTypeSelect = document.getElementById('mapTypeSelect');
        const regionSelect = document.getElementById('regionSelect');
        const currentRoundElement = document.getElementById('currentRound');
        const totalRoundsElement = document.getElementById('totalRounds');
        const currentLobbyCode = document.getElementById('currentLobbyCode');
        const roundTimer = document.getElementById('roundTimer');
        const playersStatus = document.getElementById('playersStatus');
        const lockGuessBtn = document.getElementById('lockGuessBtn');
        const hintBtn = document.getElementById('hintBtn');
        const panoramaBtn = document.getElementById('panoramaBtn');
        const hintCountElement = document.getElementById('hintCount');
        const roundResultElement = document.getElementById('roundResult');
        const distanceResultElement = document.getElementById('distanceResult');
        const roundScoreElement = document.getElementById('roundScore');
        const roundResults = document.getElementById('roundResults');
        const resultsTable = document.getElementById('resultsTable');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const winnerName = document.getElementById('winnerName');
        const winnerScore = document.getElementById('winnerScore');
        const countdown = document.getElementById('countdown');
        const connectionStatus = document.getElementById('connectionStatus');
        const leaderboardElement = document.getElementById('leaderboard');
        const addDemoPlayer1 = document.getElementById('addDemoPlayer1');
        const addDemoPlayer2 = document.getElementById('addDemoPlayer2');
        const addDemoPlayer3 = document.getElementById('addDemoPlayer3');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const guessInstructions = document.getElementById('guessInstructions');
        const streetViewInfo = document.getElementById('streetViewInfo');
        const locationInfo = document.getElementById('locationInfo');
        const locationDetails = document.getElementById('locationDetails');
        const mapLoading = document.getElementById('mapLoading');

        // Demo players data
        const demoPlayersData = [
            { id: 'demo1', name: 'Pemain2', isHost: false },
            { id: 'demo2', name: 'Pemain3', isHost: false },
            { id: 'demo3', name: 'Pemain4', isHost: false }
        ];

        // Initialize the application
        function init() {
            // Initialize UI
            setupEventListeners();
            
            // Load leaderboard
            loadLeaderboard();
            
            // Generate player ID
            gameState.playerId = generatePlayerId();
            
            // Load saved player name
            const savedName = localStorage.getItem('mapsGuesserPlayerName');
            if (savedName) {
                playerNameInput.value = savedName;
            }
            
            // Set default lobby code
            lobbyCodeInput.value = generateLobbyCode();
            
            console.log("Game initialized with Enhanced Map");
        }

        // Set up event listeners
        function setupEventListeners() {
            joinLobbyBtn.addEventListener('click', joinOrCreateLobby);
            startGameBtn.addEventListener('click', startGame);
            leaveLobbyBtn.addEventListener('click', leaveLobby);
            lockGuessBtn.addEventListener('click', lockGuess);
            hintBtn.addEventListener('click', useHint);
            panoramaBtn.addEventListener('click', showPanoramaView);
            nextRoundBtn.addEventListener('click', nextRound);
            
            // Map controls
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // Demo players buttons
            addDemoPlayer1.addEventListener('click', () => addDemoPlayer(0));
            addDemoPlayer2.addEventListener('click', () => addDemoPlayer(1));
            addDemoPlayer3.addEventListener('click', () => addDemoPlayer(2));
            
            // Map type change
            mapTypeSelect.addEventListener('change', updateMapStyle);
            
            // Enter key untuk join lobby
            lobbyCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinOrCreateLobby();
            });
            
            playerNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinOrCreateLobby();
            });
        }

        // Initialize Enhanced Map
        function initEnhancedMap() {
            if (gameState.mapInitialized) return;
            
            mapLoading.classList.remove('hidden');
            
            setTimeout(() => {
                try {
                    // Create map dengan view yang lebih menarik
                    gameState.map = L.map('map', {
                        center: [20, 0],
                        zoom: 2,
                        minZoom: 2,
                        maxZoom: 19,
                        worldCopyJump: true,
                        fullscreenControl: true,
                        zoomControl: false // We'll use custom controls
                    });

                    // Add default tile layer
                    const defaultLayer = L.tileLayer(mapProviders.streets.url, {
                        attribution: mapProviders.streets.attribution,
                        maxZoom: mapProviders.streets.maxZoom
                    }).addTo(gameState.map);

                    // Add map click listener untuk guessing
                    gameState.map.on('click', handleMapClick);

                    // Add movement listeners untuk user experience
                    gameState.map.on('movestart', () => {
                        if (gameState.roundActive) {
                            guessInstructions.classList.remove('hidden');
                        }
                    });

                    gameState.map.on('moveend', () => {
                        if (gameState.roundActive && gameState.currentGuess) {
                            updateGuessMarker();
                        }
                    });

                    // Add custom controls
                    L.control.zoom({
                        position: 'topright'
                    }).addTo(gameState.map);

                    // Show street view info for street mode
                    if (mapTypeSelect.value === 'streets') {
                        streetViewInfo.classList.remove('hidden');
                    }

                    gameState.mapInitialized = true;
                    mapLoading.classList.add('hidden');
                    
                    console.log("Enhanced Map initialized successfully");
                    
                } catch (error) {
                    console.error("Error initializing map:", error);
                    mapLoading.innerHTML = `
                        <div class="text-center">
                            <div>‚ùå Error memuat peta</div>
                            <button onclick="initEnhancedMap()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">
                                Coba Lagi
                            </button>
                        </div>
                    `;
                }
            }, 1000);
        }

        // Handle map click untuk guessing
        function handleMapClick(e) {
            if (!gameState.roundActive) return;
            
            gameState.currentGuess = e.latlng;
            updateGuessMarker();
            
            // Show confirmation button
            lockGuessBtn.classList.remove('bg-green-500');
            lockGuessBtn.classList.add('bg-blue-500');
            lockGuessBtn.textContent = '‚úÖ Konfirmasi Tebakan';
            
            // Update location info
            updateLocationInfo(e.latlng);
        }

        // Update guess marker position
        function updateGuessMarker() {
            if (!gameState.currentGuess) return;
            
            // Remove existing guess marker
            if (gameState.guessMarker) {
                gameState.map.removeLayer(gameState.guessMarker);
            }
            
            // Add new guess marker
            gameState.guessMarker = L.circleMarker(gameState.currentGuess, {
                radius: 8,
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.7,
                className: 'guess-marker'
            }).addTo(gameState.map);
            
            // Add pulsing effect
            gameState.guessMarker.bindTooltip('Tebakan Anda', {
                permanent: false,
                direction: 'top'
            });
        }

        // Update location information
        function updateLocationInfo(latlng) {
            locationInfo.classList.remove('hidden');
            
            // Simulate reverse geocoding (in real app, you'd use a geocoding service)
            const locations = [
                "Area Perkotaan",
                "Kawasan Pedesaan", 
                "Daerah Pesisir",
                "Wilayah Pegunungan",
                "Kawasan Industri",
                "Pusat Kota",
                "Suburban Area"
            ];
            
            const randomLocation = locations[Math.floor(Math.random() * locations.length)];
            
            locationDetails.innerHTML = `
                <div><strong>Koordinat:</strong> ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}</div>
                <div><strong>Jenis Area:</strong> ${randomLocation}</div>
                <div><strong>Zoom Level:</strong> ${gameState.map.getZoom()}</div>
            `;
        }

        // Lock current guess
        function lockGuess() {
            if (!gameState.currentGuess || !gameState.roundActive) {
                alert('Silakan klik di peta terlebih dahulu untuk menebak!');
                return;
            }
            
            makeGuess(gameState.currentGuess);
        }

        // Show panorama/street view
        function showPanoramaView() {
            if (!gameState.roundActive) return;
            
            // Zoom in untuk street view experience
            gameState.map.setZoom(18);
            
            // Show street view info
            streetViewInfo.classList.remove('hidden');
            
            // Add some random markers untuk simulasi street view
            const bounds = gameState.map.getBounds();
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            
            // Add some building-like rectangles
            for (let i = 0; i < 5; i++) {
                const randomLat = sw.lat + Math.random() * (ne.lat - sw.lat);
                const randomLng = sw.lng + Math.random() * (ne.lng - sw.lng);
                
                L.rectangle([
                    [randomLat - 0.001, randomLng - 0.001],
                    [randomLat + 0.001, randomLng + 0.001]
                ], {
                    color: "#666",
                    fillColor: "#ddd",
                    fillOpacity: 0.5,
                    className: 'building-layer'
                }).addTo(gameState.map);
            }
            
            alert('üèôÔ∏è Street View Mode: Telusuri area dengan zoom untuk melihat detail!');
        }

        // Zoom in function
        function zoomIn() {
            if (gameState.map) {
                gameState.map.zoomIn();
            }
        }

        // Zoom out function
        function zoomOut() {
            if (gameState.map) {
                gameState.map.zoomOut();
            }
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            if (gameState.map) {
                gameState.map.toggleFullscreen();
            }
        }

        // Update map style based on selection
        function updateMapStyle() {
            if (!gameState.map) return;
            
            const mapType = mapTypeSelect.value;
            
            // Remove existing tile layers
            gameState.map.eachLayer((layer) => {
                if (layer instanceof L.TileLayer) {
                    gameState.map.removeLayer(layer);
                }
            });
            
            // Add new tile layer
            const provider = mapProviders[mapType];
            L.tileLayer(provider.url, {
                attribution: provider.attribution,
                maxZoom: provider.maxZoom,
                subdomains: provider.subdomains || ['a','b','c']
            }).addTo(gameState.map);
            
            // Update UI based on map type
            if (mapType === 'streets') {
                streetViewInfo.classList.remove('hidden');
                guessInstructions.innerHTML = 'üéØ <strong>Street View: Klik di peta untuk menebak lokasi!</strong>';
            } else {
                streetViewInfo.classList.add('hidden');
                guessInstructions.innerHTML = 'üéØ <strong>Klik di mana saja di peta untuk menebak lokasi!</strong>';
            }
        }

        // [Rest of the functions remain the same as previous version...]
        // Generate unique player ID, lobby functions, game logic, etc.
        // Let me know if you want me to include the complete code

        // Note: Untuk menjaga panjang response, saya tidak menulis ulang semua fungsi
        // yang sama dengan versi sebelumnya. Fungsi-fungsi seperti:
        // - generatePlayerId, joinOrCreateLobby, createLobby, joinLobby
        // - setupLobby, startGame, startRound, makeGuess, calculateDistance
        // - calculateScore, useHint, showRoundResults, dll.
        // tetap sama dengan versi sebelumnya.

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
    </html>
